<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizer – ambient_1</title>
<style>
  :root{
    --ui-bg: rgba(255,255,255,.88);
    --ui-fg: #3e3e3e;
    --play-oval: rgba(140,195,120,.38);
    --font: 400 12px/22px Clarkson, "Proxima Nova", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  html,body{margin:0;height:100%;background:#000;color:var(--ui-fg);font:var(--font)}
  #vizwrap{position:relative;width:100%;height:100vh;background:#000;overflow:hidden}
  #viz{position:absolute;inset:0;display:block;width:100%;height:100%}

  /* Hover UI: hidden by default; appears on hover (or when we add .show-ui briefly) */
  .ui{
    position:absolute;left:0;right:0;bottom:0;display:flex;align-items:center;gap:.75rem;
    padding:.6rem .8rem;background:var(--ui-bg);color:var(--ui-fg);
    border-top-left-radius:10px;border-top-right-radius:10px;
    opacity:0;transform:translateY(8px);
    transition:opacity .25s ease, transform .25s ease;
    pointer-events:none;
  }
  #vizwrap:hover .ui, #vizwrap.show-ui .ui{opacity:1;transform:none;pointer-events:auto}

  /* Starter overlay (big play button) */
  /* Starter overlay – shared cover for all tracks */
.starter{
  position:absolute;
  inset:0;
  z-index:20;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:32px;
  background:
    linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55)),
    url('https://rkangeluk.github.io/psy-viz1/covers/psy_cover.jpeg')
      center center / cover no-repeat;
}

/* Track title over the cover */
.track-title{
  font-size:clamp(22px, 3vw, 32px);
  font-weight:400;
  color:#ffffff;
  text-shadow:0 2px 10px rgba(0,0,0,0.8);
}

/* Play button – styled like your mockup */
.play-oval{
  all:unset;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  min-width:200px;         /* narrower */
  height:64px;             /* shorter */
  padding:0 32px;          /* smaller left/right padding */
  border-radius:9999px;
  background:rgba(197,203,157,0.78);
  border:2px solid #6e7f3d;
  box-shadow:0 8px 24px rgba(0,0,0,0.35);
}
.play-oval svg{
  width:28px;
  height:28px;
  fill:#486020;
}



  /* Buttons / sliders */
  .btn{
    all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
    width:36px;height:36px;border-radius:9999px;background:rgba(0,0,0,.06);color:var(--ui-fg)
  }
  .btn:hover{background:rgba(0,0,0,.12)}
  .pill{all:unset;cursor:pointer;background:rgba(0,0,0,.06);padding:.35rem .6rem;border-radius:999px}
  .pill:hover{background:rgba(0,0,0,.12)}
  .label{opacity:.85;min-width:52px;text-align:right}
  .grow{flex:1}.spacer{width:8px}
  input[type="range"]{-webkit-appearance:none;appearance:none;height:4px;width:240px;background:rgba(0,0,0,.18);border-radius:999px;outline:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:#3e3e3e;box-shadow:0 0 0 2px rgba(255,255,255,.8)}
</style>
</head>
<body>
  <div id="vizwrap" aria-label="Audio visualizer">
    <canvas id="viz"></canvas>

    <!-- Hover-only UI (hidden until hover) -->
    <div class="ui" role="group" aria-label="Player controls">
      <button id="play" class="btn" aria-label="Play/Pause">▶</button>
      <span id="time" class="label">0:00</span>
      <input id="seek" type="range" min="0" max="1" step="0.001" value="0" class="grow" aria-label="Seek"/>
      <span id="dur" class="label">0:00</span>
      <div class="spacer"></div>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:110px" aria-label="Volume"/>
      <div class="spacer"></div>
      <button id="next" class="pill" aria-label="Next preset">Next</button>
    </div>

    <!-- “User gesture” gate -->
    <div id="starter" class="starter" role="dialog" aria-label="Click to start">
  <div class="track-title">Ambient 1</div>
  <button id="startBtn" class="play-oval" aria-label="Play" type="button">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
  </button>
</div>


    <!-- Audio: use an absolute URL to avoid CORS/autoplay quirks -->
    <audio id="player" preload="auto" crossorigin="anonymous">
      <source src="https://rkangeluk.github.io/psy-viz1/ambient_1.mp3" type="audio/mpeg">
    </audio>
  </div>

  <!-- Butterchurn core + preset packs -->
  <script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurn.min.js"></script>
  <script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurnExtraImages.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js"></script>

  <script>
  /* ===== ambient_1: single obscure preset + hover UI ===== */

  // Per-track config
  const TRACK_SEED = "ambient_1_obscure"; // change per track to get a different preset
  const audio      = document.getElementById('player');

  const wrap    = document.getElementById('vizwrap');
  const canvas  = document.getElementById('viz');
  const starter = document.getElementById('starter');
  const startBtn= document.getElementById('startBtn');
  const btnPlay = document.getElementById('play');
  const btnNext = document.getElementById('next');
  const rSeek   = document.getElementById('seek');
  const rVol    = document.getElementById('vol');
  const tTime   = document.getElementById('time');
  const tDur    = document.getElementById('dur');

  let ctx, viz, PRESETS;
  let keys = [];       // filtered "obscure" preset names
  let index = 0;       // current preset index
  let started = false;

  function getBC(){
    const bc = window.butterchurn;
    return bc && (typeof bc.createVisualizer === 'function' ? bc : bc.default);
  }

  function getPresetsDict(){
    const dict = Object.assign({},
      (butterchurnPresets?.default || butterchurnPresets)?.getPresets?.() || {},
      (butterchurnPresetsNonMinimal?.default || butterchurnPresetsNonMinimal)?.getPresets?.() || {},
      (butterchurnPresetsExtra?.default || butterchurnPresetsExtra)?.getPresets?.() || {},
      (butterchurnPresetsExtra2?.default || butterchurnPresetsExtra2)?.getPresets?.() || {},
    );
    return { dict, names: Object.keys(dict) };
  }

  function size(){
    const r = wrap.getBoundingClientRect();
    canvas.width  = r.width;
    canvas.height = r.height;
    viz && viz.setRendererSize(r.width, r.height);
  }

  // Show UI briefly on interaction (not on preset transitions)
  function hintUI(){
    wrap.classList.add('show-ui');
    clearTimeout(wrap._h);
    wrap._h = setTimeout(()=>wrap.classList.remove('show-ui'), 1200);
  }
  ['keydown','pointerdown'].forEach(evt=>{
    document.addEventListener(evt, hintUI, {passive:true});
  });

  // Simple PRNG for deterministic preset choice based on TRACK_SEED
  function xmur3(str) {
    let h = 1779033703 ^ str.length;
    for (let i = 0; i < str.length; i++) {
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = (h << 13) | (h >>> 19);
    }
    return function() {
      h = Math.imul(h ^ (h >>> 16), 2246822507);
      h = Math.imul(h ^ (h >>> 13), 3266489909);
      return (h ^= h >>> 16) >>> 0;
    };
  }
  function mulberry32(a) {
    return function() {
      let t = (a += 0x6D2B79F5);
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function buildObscurePresetList() {
    const { dict, names } = PRESETS;
    const skipWords = ["geiss", "yin", "milkdrop", "flexi", "martin", "yurop"]; // whatever you dislike
    let obscure = names.filter(name =>
      !skipWords.some(w => name.toLowerCase().includes(w))
    );
    if (!obscure.length) obscure = names.slice(); // fallback if filter too aggressive
    return obscure;
  }

  function loadPresetByIndex(i, blend) {
    if (!keys.length) keys = buildObscurePresetList();
    if (!keys.length) return;

    index = ((i % keys.length) + keys.length) % keys.length;
    const name = keys[index];
    const base = PRESETS.dict[name];
    if (!base) return;

    console.log("Using preset:", name);
    viz.loadPreset(base, blend);
  }

  async function boot(){
    const BC = getBC();
    if (!BC) { alert('Butterchurn failed to load'); return false; }

    PRESETS = getPresetsDict();
    if (!PRESETS.names.length) { alert('No presets available'); return false; }

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    ctx = new AudioCtx({ latencyHint:'interactive' });
    const srcNode = ctx.createMediaElementSource(audio);

    // Volume controlled by HTML range (we also feed a Gain node into Butterchurn)
    const g = ctx.createGain();
    g.gain.value = +rVol.value;

    // To speakers
    srcNode.connect(ctx.destination);
    // To visualizer
    srcNode.connect(g);

    viz = BC.createVisualizer(ctx, canvas, {
      width: canvas.clientWidth,
      height: canvas.clientHeight,
      pixelRatio: 1
    });
    viz.connectAudio(g);

    size();
    window.addEventListener('resize', size, {passive:true});

    (function loop() {
      viz && viz.render();
      requestAnimationFrame(loop);
    })();

    // Build preset list and pick a deterministic starting preset
    keys = buildObscurePresetList();
    const seedFn = xmur3(TRACK_SEED);
    const rand   = mulberry32(seedFn());
    index = Math.floor(rand() * keys.length);
    loadPresetByIndex(index, 0.0); // no blend on first load

    // Transport wiring
    rVol.addEventListener('input', e => {
      const v = +e.target.value;
      audio.volume = v;
      g.gain.value = v;
    }, {passive:true});

    rSeek.addEventListener('input', e => {
      if (audio.duration) {
        audio.currentTime = e.target.value * audio.duration;
      }
    }, {passive:true});

    audio.addEventListener('timeupdate', () => {
      const t = audio.currentTime || 0;
      tTime.textContent = `${Math.floor(t/60)}:${String(Math.floor(t%60)).padStart(2,'0')}`;
      if (audio.duration) {
        const d = audio.duration;
        tDur.textContent = `${Math.floor(d/60)}:${String(Math.floor(d%60)).padStart(2,'0')}`;
        rSeek.value = t / d;
      }
    });

    return true;
  }

  async function startPlayback(){
    try {
      if (!started) {
        const ok = await boot();
        if (!ok) return;
        started = true;
      }
      if (ctx.state === 'suspended') await ctx.resume();
      await audio.play();
      starter.style.display = 'none';
      btnPlay.textContent   = '⏸';
    } catch(e) {
      console.error(e);
      alert('Could not start audio.');
    }
  }

  // Start hooks: overlay, button, canvas, keyboard
  startBtn.addEventListener('click', startPlayback);
  starter.addEventListener('click', (e)=>{ if (e.target === starter) startPlayback(); });
  canvas.addEventListener('click', startPlayback);
  document.addEventListener('keydown', (e)=>{
    if (e.code === 'Space' || e.key === 'Enter') startPlayback();
  });

  // Play/Pause
  btnPlay.addEventListener('click', async () => {
    try {
      if (!started) {
        const ok = await boot();
        if (!ok) return;
        started = true;
      }
      if (audio.paused) {
        if (ctx.state === 'suspended') await ctx.resume();
        await audio.play();
        btnPlay.textContent = '⏸';
      } else {
        audio.pause();
        btnPlay.textContent = '▶';
      }
    } catch(e) {
      console.error(e);
      alert('Could not toggle audio.');
    }
  });

  // Manual "Next" – cycles through other obscure presets (no auto cadence)
  btnNext.addEventListener('click', () => {
    if (!viz || !PRESETS) return;
    loadPresetByIndex(index + 1, 1.0);
  });

  // Preload metadata
  audio.load();
  </script>
</body>
</html>
