<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ambient 1 Visualizer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #ccc;
    }
    #wrap {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #visualizer {
      width: 100vw;
      height: 100vh;
      display: block;
    }
    #overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center, rgba(255,255,255,0.05), rgba(0,0,0,0.9));
      cursor: pointer;
      z-index: 10;
    }
    #overlay-inner {
      text-align: center;
      padding: 1.5rem 2rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(8px);
    }
    #overlay-inner span {
      display: block;
      font-size: 0.9rem;
      opacity: 0.7;
      margin-top: 0.35rem;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="visualizer"></canvas>
    <div id="overlay">
      <div id="overlay-inner">
        ▶ Play “ambient_1”
        <span>Click to start audio + visualiser</span>
      </div>
    </div>
  </div>

  <!-- Audio element (hidden) -->
  <audio id="audio" preload="auto" crossorigin="anonymous"></audio>

  <!-- Butterchurn + presets -->
  <script src="https://unpkg.com/butterchurn"></script>
  <script src="https://unpkg.com/butterchurn-presets"></script>

  <script>
    // ---- PER-TRACK SETTINGS ----
    const AUDIO_URL = "https://rkangeluk.github.io/psy-viz1/ambient_1.mp3";
    const TRACK_SEED = "ambient_1_obscure"; // different seed per track

    const audioEl = document.getElementById("audio");
    const canvas = document.getElementById("visualizer");
    const overlay = document.getElementById("overlay");

    audioEl.src = AUDIO_URL;

    let audioCtx;
    let source;
    let visualizer;
    let started = false;

    // Tiny deterministic PRNG to pick an "obscure" preset per track
    function xmur3(str) {
      let h = 1779033703 ^ str.length;
      for (let i = 0; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
      };
    }

    function mulberry32(a) {
      return function() {
        let t = (a += 0x6D2B79F5);
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function pickObscurePreset() {
      const presetObj = butterchurnPresets.getPresets();
      let keys = Object.keys(presetObj);

      // Filter out some of the more obvious / “famous” authors
      const skipWords = ["Geiss", "Yin", "Flexi", "Milkdrop"];
      keys = keys.filter(name =>
        !skipWords.some(w => name.toLowerCase().includes(w.toLowerCase()))
      );

      // Fallback to full list if filter over-aggressive
      if (keys.length === 0) {
        keys = Object.keys(presetObj);
      }

      const seedFn = xmur3(TRACK_SEED);
      const rand = mulberry32(seedFn());
      const idx = Math.floor(rand() * keys.length);
      const chosenName = keys[idx];

      console.log("Chosen preset:", chosenName);
      return presetObj[chosenName];
    }

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;
      if (visualizer) {
        visualizer.setRendererSize(canvas.width, canvas.height);
      }
    }

    function initAudioAndVisualizer() {
      if (started) return;
      started = true;

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      source = audioCtx.createMediaElementSource(audioEl);

      const gainNode = audioCtx.createGain();
      gainNode.gain.value = 1.0;

      source.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      visualizer = butterchurn.default.createVisualizer(audioCtx, canvas, {
        width: canvas.width,
        height: canvas.height,
        pixelRatio: window.devicePixelRatio || 1,
      });

      const preset = pickObscurePreset();
      visualizer.loadPreset(preset, 2.0); // 2s blend (only on first load)

      resizeCanvas();

      const render = () => {
        visualizer.render();
        requestAnimationFrame(render);
      };
      render();
    }

    async function startPlayback() {
      overlay.style.display = "none";

      if (!audioCtx) {
        initAudioAndVisualizer();
      }
      if (audioCtx.state === "suspended") {
        await audioCtx.resume();
      }
      try {
        await audioEl.play();
      } catch (e) {
        console.error("Playback failed:", e);
      }
    }

    overlay.addEventListener("click", startPlayback);
    canvas.addEventListener("click", startPlayback);
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space" || e.code === "Enter") {
        startPlayback();
      }
    });

    window.addEventListener("resize", resizeCanvas);
  </script>
</body>
</html>
