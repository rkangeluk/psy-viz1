<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Butterchurn Preset Lab v3 (tint overlay)</title>
<style>
  :root{
    --ui-bg: rgba(255,255,255,.88);
    --ui-fg: #3e3e3e;
    --accent: rgba(140,195,120,.38);
    --font: 400 13px/20px Clarkson,"Proxima Nova","Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
  }
  html,body{margin:0;height:100%;background:#000;color:#eaeaea;font:var(--font)}
  #layout{display:grid;grid-template-columns:360px 1fr;grid-template-rows:auto 1fr auto;min-height:100vh}
  header{grid-column:1/-1;padding:10px 14px;background:#0b0b0b;border-bottom:1px solid #1e1e1e;display:flex;gap:12px;align-items:center}
  header h1{margin:0;font-size:14px;font-weight:600;color:#fff;letter-spacing:.3px}
  #left{grid-row:2 / span 1; grid-column:1; background:#0f0f0f; border-right:1px solid #1e1e1e; padding:12px; display:flex; flex-direction:column; gap:12px; overflow:auto}
  #right{grid-row:2 / span 1; grid-column:2; position:relative; background:#000}
  #viz{position:absolute;inset:0;display:block;width:100%;height:100%}
  #probe{position:absolute;left:-9999px;top:-9999px;width:64px;height:64px}

  /* NEW: visible tint overlay */
  #tintOverlay{
    position:absolute; inset:0;
    pointer-events:none;
    mix-blend-mode:color;   /* apply hue to the viz */
    opacity:0;              /* driven by Tint strength slider */
    background:#ffffff;     /* updated live from RGB sliders */
  }

  fieldset{border:1px solid #1e1e1e;border-radius:10px;padding:10px}
  legend{padding:0 6px;color:#cfcfcf}
  label{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0}
  input[type="text"], input[type="number"], select, textarea{
    width:100%; padding:8px 10px; border-radius:8px; border:1px solid #242424; background:#121212; color:#e5e5e5; outline:none;
  }
  input[type="range"]{width:100%}
  button{all:unset;cursor:pointer;background:#1b1b1b;border:1px solid #2a2a2a;padding:8px 10px;border-radius:10px;text-align:center}
  button:hover{background:#242424}
  .row{display:grid;grid-template-columns:1fr 1fr; gap:8px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr; gap:8px}
  .muted{opacity:.8}
  #timeline{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
  .cue{display:flex;align-items:center;gap:8px;background:#0b0b0b;border:1px solid #1e1e1e;border-radius:8px;padding:6px}
  .cue .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .danger{color:#ff7b7b}
  footer{grid-column:1/-1;padding:10px;background:#0b0b0b;border-top:1px solid #1e1e1e;display:flex;gap:10px;align-items:center}
  .playbar{display:flex;align-items:center;gap:8px}
  .playbtn{width:38px; height:38px; display:inline-flex; align-items:center; justify-content:center; border-radius:9999px; background:var(--accent); color:#fff; border:none}
  .badge{padding:2px 6px;border:1px solid #2a2a2a;border-radius:999px;font-size:11px;background:#111}
</style>
</head>
<body>
<div id="layout">
  <header>
    <h1>Butterchurn Preset Lab v3</h1>
    <span class="badge">Live Style</span>
    <span class="badge">Sequencer</span>
    <span class="badge">Editor</span>
    <span class="badge">Export</span>
  </header>

  <aside id="left">
    <fieldset>
      <legend>Audio</legend>
      <div class="row">
        <label>File <input id="audioSrc" type="text" placeholder="track3.mp3" value="track3.mp3"/></label>
        <label>BPM <input id="bpm" type="number" min="60" max="200" step="1" value="134"/></label>
      </div>
      <div class="playbar">
        <button id="play" class="playbtn" title="Play/Pause">▶</button>
        <span id="cur" class="muted">0:00</span>
        <input id="seek" type="range" min="0" max="1" step="0.001" value="0" style="flex:1"/>
        <span id="dur" class="muted">0:00</span>
      </div>
      <div class="row">
        <label>Volume <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9"/></label>
        <label>Current bar <input id="bar" type="text" readonly/></label>
      </div>
      <div class="row">
        <button id="reloadAudio">Load audio</button>
        <button id="snap0">Snap to bar 1</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Preset & Style (Live)</legend>
      <label>Preset <select id="presetSelect"><option>Loading…</option></select></label>
      <div class="row3">
        <label>Gamma <input id="gamma" type="range" min="0.8" max="1.6" step="0.01" value="1.20"/></label>
        <label>Decay <input id="decay" type="range" min="0.96" max="0.996" step="0.001" value="0.985"/></label>
        <label>Warp <input id="warp" type="range" min="0.0" max="0.05" step="0.001" value="0.014"/></label>
      </div>
      <div class="row3">
        <label>Tint R <input id="tR" type="range" min="0" max="2" step="0.01" value="1.00"/></label>
        <label>Tint G <input id="tG" type="range" min="0" max="2" step="0.01" value="1.00"/></label>
        <label>Tint B <input id="tB" type="range" min="0" max="2" step="0.01" value="1.00"/></label>
      </div>
      <!-- NEW: tint strength slider -->
      <div class="row">
        <label>Tint strength
          <input id="tStrength" type="range" min="0" max="1" step="0.01" value="0.00"/>
        </label>
      </div>
      <div class="row">
        <label>Micro morph (bars) <input id="micro" type="number" min="2" max="16" step="2" value="4"/></label>
        <label>Blend (s) <input id="blendSec" type="number" min="0" max="6" step="0.1" value="1.2"/></label>
      </div>
      <div class="row">
        <button id="applyNow">Apply to Live</button>
        <button id="previewNext">Preview as Next</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Timeline (bar-based cues)</legend>
      <div class="row">
        <label>Add at bar <input id="cueBar" type="number" min="1" step="1" value="1"/></label>
        <label>Blend (s) <input id="cueBlend" type="number" min="0" max="6" step="0.1" value="1.6"/></label>
      </div>
      <div class="row">
        <button id="addCue">+ Add cue for selected preset</button>
        <button id="clearCues" class="danger">Clear all</button>
      </div>
      <div id="timeline"></div>
    </fieldset>

    <fieldset>
      <legend>Quick Sequencer (up to 5)</legend>
      <div id="seqRows" style="display:grid;gap:6px;"></div>
      <div class="row">
        <button id="seqApply">Build cues from sequence</button>
        <button id="seqClear">Clear sequence</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Edit Preset (derive)</legend>
      <div class="row3">
        <label>Deriv. Name <input id="edName" type="text" placeholder="My Preset • custom"/></label>
        <label>Gamma <input id="edGamma" type="number" step="0.01" min="0.5" max="2" value="1.20"/></label>
        <label>Decay <input id="edDecay" type="number" step="0.001" min="0.95" max="0.999" value="0.985"/></label>
      </div>
      <div class="row3">
        <label>Tint R <input id="edR" type="number" min="0" max="2" step="0.01" value="1.00"/></label>
        <label>Tint G <input id="edG" type="number" min="0" max="2" step="0.01" value="1.00"/></label>
        <label>Tint B <input id="edB" type="number" min="0" max="2" step="0.01" value="1.00"/></label>
      </div>
      <label>per_frame (Milkdrop eq)
        <textarea id="edPerFrame" style="height:90px" spellcheck="false"></textarea>
      </label>
      <label>per_pixel (Milkdrop eq)
        <textarea id="edPerPixel" style="height:90px" spellcheck="false"></textarea>
      </label>
      <div class="row">
        <button id="edLoad">Load selected into editor</button>
        <button id="edApply">Apply edits live</button>
      </div>
      <div class="row">
        <button id="edDownload">Download JSON</button>
        <button id="edMakeCue">Cue this at current bar</button>
      </div>
      <p class="muted" style="margin:6px 0 0">Tip: tweak EQ strings, tint & trails; apply live; then download.</p>
    </fieldset>
  </aside>

  <main id="right">
    <canvas id="viz"></canvas>
    <!-- NEW overlay sits above the canvas -->
    <div id="tintOverlay" aria-hidden="true"></div>

    <canvas id="probe" width="64" height="64" aria-hidden="true"></canvas>
    <audio id="player" preload="auto" playsinline crossorigin="anonymous"></audio>
  </main>

  <footer>
    <button id="export">Export Code</button>
    <span class="muted">Copy into your production visualizer.</span>
    <textarea id="out" spellcheck="false" readonly style="flex:1;height:120px;margin-left:8px">// exported code will appear here…</textarea>
  </footer>
</div>

<!-- Libraries with CDN fallback -->
<script>
function loadScriptPair(primary, fallback){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script'); s.src=primary; s.async=false;
    s.onload=resolve;
    s.onerror=()=>{ const f=document.createElement('script'); f.src=fallback; f.async=false; f.onload=resolve; f.onerror=()=>reject(new Error('CDN fail '+primary)); document.head.appendChild(f); };
    document.head.appendChild(s);
  });
}
(async function libs(){
  const u='https://unpkg.com/', j='https://cdn.jsdelivr.net/npm/';
  await loadScriptPair(u+'butterchurn@2.6.7/lib/butterchurn.min.js',              j+'butterchurn@2.6.7/lib/butterchurn.min.js');
  await loadScriptPair(u+'butterchurn@2.6.7/lib/butterchurnExtraImages.min.js',   j+'butterchurn@2.6.7/lib/butterchurnExtraImages.min.js');
  await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js',        j+'butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js');
  await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js', j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js');
  await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js',   j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js');
  await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js',  j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js');
  window._libsReady = true;
})();
</script>

<script>
/* ---------- DOM ---------- */
const wrap = document.getElementById('right');
const canvas = document.getElementById('viz');
const tintOverlay = document.getElementById('tintOverlay'); // NEW
const probe = document.getElementById('probe');
const audio = document.getElementById('player');

const selPreset = document.getElementById('presetSelect');
const gamma = document.getElementById('gamma');
const decay = document.getElementById('decay');
const warp = document.getElementById('warp');
const tR = document.getElementById('tR'), tG = document.getElementById('tG'), tB = document.getElementById('tB');
const tStrength = document.getElementById('tStrength'); // NEW
const micro = document.getElementById('micro');
const blendSec = document.getElementById('blendSec');

const bpmEl = document.getElementById('bpm');
const audioSrc = document.getElementById('audioSrc');
const curEl = document.getElementById('cur'), durEl = document.getElementById('dur'), seekEl = document.getElementById('seek');
const volEl = document.getElementById('vol'), barEl = document.getElementById('bar');

const playBtn = document.getElementById('play');
const reloadBtn = document.getElementById('reloadAudio');
const snap0Btn = document.getElementById('snap0');

const addCueBtn = document.getElementById('addCue'), clearCuesBtn = document.getElementById('clearCues');
const cueBar = document.getElementById('cueBar'), cueBlend = document.getElementById('cueBlend');
const timeline = document.getElementById('timeline');
const exportBtn = document.getElementById('export'), out = document.getElementById('out');

const seqRows = document.getElementById('seqRows');
const seqApply = document.getElementById('seqApply');
const seqClear = document.getElementById('seqClear');

/* Editor */
const edName = document.getElementById('edName');
const edGamma = document.getElementById('edGamma');
const edDecay = document.getElementById('edDecay');
const edR = document.getElementById('edR'), edG = document.getElementById('edG'), edB = document.getElementById('edB');
const edPerFrame = document.getElementById('edPerFrame');
const edPerPixel = document.getElementById('edPerPixel');
const edLoad = document.getElementById('edLoad');
const edApply = document.getElementById('edApply');
const edDownload = document.getElementById('edDownload');
const edMakeCue = document.getElementById('edMakeCue');

/* ---------- state ---------- */
let ctx, src, viz, PRESETS={dict:{}, names:[]}, started=false;
let cues=[]; // {bar, name, blendSec, _done?}
let currentPresetName=null;
let microTimer=null, cueTimer=null, whiteWatch=null;

/* ---------- utils ---------- */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function fmt(t){ if(!isFinite(t)) return '0:00'; const m=(t/60|0), s=t%60|0; return m+':'+(s<10?'0':'')+s; }
function size(){ const r=wrap.getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height; viz && viz.setRendererSize(r.width,r.height); }
function MS_PER_BAR(){ const bpm = parseFloat(bpmEl.value||120); return (60000/bpm)*4; }
function currentBar(){ return ((audio.currentTime*1000)/MS_PER_BAR())+1; } // 1-based
function webglOK(){ const c=document.createElement('canvas'); return !!(c.getContext('webgl2')||c.getContext('webgl')||c.getContext('experimental-webgl')); }

/* NEW: visible overlay tint from RGB + strength */
function updateOverlayTint(){
  let r=+tR.value, g=+tG.value, b=+tB.value;
  const max=Math.max(r,g,b,1);
  r=Math.min(255,Math.round(255*r/max));
  g=Math.min(255,Math.round(255*g/max));
  b=Math.min(255,Math.round(255*b/max));
  tintOverlay.style.background = `rgb(${r},${g},${b})`;
  tintOverlay.style.opacity = (+tStrength.value).toString();
}

function mergePresetPacks(){
  const libs=[];
  if (window.butterchurnPresets) libs.push((butterchurnPresets.default||butterchurnPresets).getPresets());
  if (window.butterchurnPresetsNonMinimal) libs.push((butterchurnPresetsNonMinimal.default||butterchurnPresetsNonMinimal).getPresets());
  if (window.butterchurnPresetsExtra) libs.push((butterchurnPresetsExtra.default||butterchurnPresetsExtra).getPresets());
  if (window.butterchurnPresetsExtra2) libs.push((butterchurnPresetsExtra2.default||butterchurnPresetsExtra2).getPresets());
  const dict=Object.assign({},...libs), names=Object.keys(dict);
  return {dict,names};
}

/* ---------- presets UI ---------- */
function fillPresetSelect(){
  selPreset.innerHTML='';
  PRESETS.names.sort().forEach(n=>{
    const o=document.createElement('option'); o.value=n; o.textContent=n; selPreset.appendChild(o);
  });
  const pick = PRESETS.names.find(n=>/kaleid|tunnel|vortex|reaction|nebula|fluid|flow|spiral/i.test(n)) || PRESETS.names[0];
  selPreset.value = pick;
}

/* ---------- style mutate (LIVE) ---------- */
function mutate(base){
  const p = JSON.parse(JSON.stringify(base));
  p.ob_a = 0; p.ib_a = 0;
  p.gamma = parseFloat(gamma.value);
  p.decay = parseFloat(decay.value);
  const w = parseFloat(warp.value);
  const warpEq =
    `qB = 0.85*qB + 0.15*bass_att; `
  + `zoom = zoom * (1.0 + ${w.toFixed(4)} * qB); `
  + `rot = rot + ${Math.max(0.0003, w/10).toFixed(5)} * (qB - 0.5);`;
  p.per_frame = (p.per_frame || "") + warpEq;

  const tr = parseFloat(tR.value), tg = parseFloat(tG.value), tb = parseFloat(tB.value);
  if (Array.isArray(p.waves)) {
    p.waves.forEach(wv => {
      if (typeof wv.r === 'number') wv.r = Math.max(0, Math.min(1, wv.r * tr));
      if (typeof wv.g === 'number') wv.g = Math.max(0, Math.min(1, wv.g * tg));
      if (typeof wv.b === 'number') wv.b = Math.max(0, Math.min(1, wv.b * tb));
    });
  }
  if (Array.isArray(p.shapes)) {
    p.shapes.forEach(sh => {
      if (typeof sh.r === 'number') sh.r = Math.max(0, Math.min(1, sh.r * tr));
      if (typeof sh.g === 'number') sh.g = Math.max(0, Math.min(1, sh.g * tg));
      if (typeof sh.b === 'number') sh.b = Math.max(0, Math.min(1, sh.b * tb));
    });
  }
  return p;
}
function loadPresetByName(name, blendSeconds){
  const base = PRESETS.dict[name]; if(!base) return;
  currentPresetName = name;
  viz.loadPreset(mutate(base), Math.max(0, blendSeconds||0));
  armWhiteWatch(name);
  console.log('Loaded:', name);
}
const applyLiveDebounced = debounce(()=> {
  if (!currentPresetName || !viz || !PRESETS.dict[currentPresetName]) return;
  const base = PRESETS.dict[currentPresetName];
  viz.loadPreset(mutate(base), 0.3);
}, 120);
[gamma, decay, warp, tR, tG, tB, tStrength].forEach(el => el.addEventListener('input', ()=>{
  applyLiveDebounced();
  updateOverlayTint(); // keep overlay in sync
}, { passive:true }));

/* ---------- micro morph ---------- */
function scheduleMicro(){
  if (microTimer) clearInterval(microTimer);
  const span = Math.max(2, parseInt(micro.value||4,10));
  microTimer = setInterval(()=>{
    if (!currentPresetName) return;
    loadPresetByName(currentPresetName, 0.6);
  }, MS_PER_BAR()*span);
}

/* ---------- cues ---------- */
function scheduleCues(){
  if (cueTimer) clearInterval(cueTimer);
  const tick = 100;
  cueTimer = setInterval(()=>{
    const tms = audio.currentTime*1000;
    const due = cues.filter(c => !c._done && tms >= (c.bar-1)*MS_PER_BAR()-50);
    if (due.length){
      due.sort((a,b)=>a.bar-b.bar).forEach(c=>{
        c._done=true;
        loadPresetByName(c.name, c.blendSec);
      });
      renderTimeline();
    }
    barEl.value = Math.max(1, Math.floor(currentBar()));
  }, tick);
}
function renderTimeline(){
  timeline.innerHTML='';
  if (!cues.length){ const d=document.createElement('div'); d.className='muted'; d.textContent='No cues yet.'; timeline.appendChild(d); return; }
  cues.sort((a,b)=>a.bar-b.bar);
  cues.forEach((c,idx)=>{
    const row=document.createElement('div'); row.className='cue';
    const left=document.createElement('div'); left.className='name'; left.textContent=`Bar ${c.bar} • ${c.name}`;
    const mid=document.createElement('div'); mid.textContent=`blend ${c.blendSec}s`; mid.className='muted';
    const del=document.createElement('button'); del.textContent='✕'; del.title='Remove';
    del.onclick=()=>{ cues.splice(idx,1); renderTimeline(); scheduleCues(); };
    row.appendChild(left); row.appendChild(mid); row.appendChild(del);
    timeline.appendChild(row);
  });
}

/* ---------- export ---------- */
function exportCode(){
  const style = {
    gamma:+gamma.value, decay:+decay.value, warp:+warp.value,
    tint:{ r:+tR.value, g:+tG.value, b:+tB.value },
    overlay:{ strength:+tStrength.value },        // NEW
    microBars: parseInt(micro.value,10)
  };
  const schedule = cues.slice().sort((a,b)=>a.bar-b.bar).map(c=>({ bar:c.bar, name:c.name, blendSec:c.blendSec }));
  const code =
`// ====== Generated with Preset Lab v3 ======
const SCHEDULE = ${JSON.stringify(schedule, null, 2)};

function applyStyle(base){
  const p = JSON.parse(JSON.stringify(base));
  p.ob_a=0; p.ib_a=0;
  p.gamma = ${style.gamma};
  p.decay = ${style.decay};
  p.per_frame = (p.per_frame||"") + "qB=0.85*qB+0.15*bass_att; zoom=zoom*(1.0+${style.warp.toFixed(4)}*qB); rot=rot+${Math.max(0.0003, style.warp/10).toFixed(5)}*(qB-0.5);";
  if (Array.isArray(p.waves)) p.waves.forEach(w=>{ if(typeof w.r==='number')w.r*=${style.tint.r}; if(typeof w.g==='number')w.g*=${style.tint.g}; if(typeof w.b==='number')w.b*=${style.tint.b}; });
  if (Array.isArray(p.shapes)) p.shapes.forEach(s=>{ if(typeof s.r==='number')s.r*=${style.tint.r}; if(typeof s.g==='number')s.g*=${style.tint.g}; if(typeof s.b==='number')s.b*=${style.tint.b}; });
  return p;
}
const MICRO_BARS = ${style.microBars};
// Note: if you want the visible overlay tint in production, add a
// CSS mix-blend-mode:color overlay above your canvas and set its opacity to ${style.overlay.strength}.
`;
  out.value = code;
}

/* ---------- sequencer UI (5 steps) ---------- */
function buildSequencerUI(){
  seqRows.innerHTML='';
  const barOpts = [16,32,48,64];

  const r1 = document.createElement('div');
  r1.innerHTML = `<div class="row" style="grid-template-columns: 1fr;">
      <label>Launch preset <select class="seq-preset"></select></label></div>`;
  seqRows.appendChild(r1);

  for (let i=2;i<=5;i++){
    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = `
      <label>After
        <select class="seq-bars">${barOpts.map(n=>`<option value="${n}">${n} bars</option>`).join('')}</select>
      </label>
      <label>→ Preset
        <select class="seq-preset"></select>
      </label>`;
    seqRows.appendChild(row);
  }

  const fill = sel=>{
    sel.innerHTML='';
    PRESETS.names.sort().forEach(n=>{
      const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o);
    });
  };
  seqRows.querySelectorAll('.seq-preset').forEach(fill);
}
function applySequencerToCues(){
  const rows = Array.from(seqRows.children);
  if (!rows.length) return;
  const launchPreset = rows[0].querySelector('.seq-preset').value;
  const blendDefault = parseFloat(cueBlend.value || 1.6);

  const seq = [{ bar: 1, name: launchPreset, blendSec: 0.0 }];
  let curBar = 1;
  for (let i=1;i<rows.length;i++){
    const barsSel = rows[i].querySelector('.seq-bars');
    const presetSel = rows[i].querySelector('.seq-preset');
    if (!barsSel || !presetSel) continue;
    const inc = parseInt(barsSel.value, 10);
    const name = presetSel.value;
    if (!Number.isFinite(inc) || !name) continue;
    curBar += inc;
    seq.push({ bar: curBar, name, blendSec: blendDefault });
  }

  cues = seq.slice();
  cues.forEach(c => delete c._done);
  renderTimeline();
  scheduleCues();

  currentPresetName = launchPreset;
  if (viz && PRESETS.dict[launchPreset]) viz.loadPreset(mutate(PRESETS.dict[launchPreset]), 0.0);
}
seqApply.addEventListener('click', applySequencerToCues);
seqClear.addEventListener('click', ()=>{ seqRows.innerHTML=''; cues.length=0; renderTimeline(); scheduleCues(); });

/* ---------- Editor (derive) ---------- */
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function buildDerivativeFromEditor(baseName){
  const base = PRESETS.dict[baseName];
  if (!base) { alert('Base preset not found: '+baseName); return null; }
  const p = deepClone(base);
  p.name = edName.value.trim() || (baseName + ' • custom');
  p.gamma = parseFloat(edGamma.value)||p.gamma||1.2;
  p.decay = parseFloat(edDecay.value)||p.decay||0.985;
  p.ob_a = 0; p.ib_a = 0;
  if (edPerFrame.value.trim()) p.per_frame = (p.per_frame||"") + "\n" + edPerFrame.value;
  if (edPerPixel.value.trim()) p.per_pixel = (p.per_pixel||"") + "\n" + edPerPixel.value;

  const tr = parseFloat(edR.value)||1, tg = parseFloat(edG.value)||1, tb = parseFloat(edB.value)||1;
  if (Array.isArray(p.waves)){ p.waves.forEach(w=>{ if(typeof w.r==='number')w.r=Math.max(0,Math.min(1,w.r*tr)); if(typeof w.g==='number')w.g=Math.max(0,Math.min(1,w.g*tg)); if(typeof w.b==='number')w.b=Math.max(0,Math.min(1,w.b*tb)); }); }
  if (Array.isArray(p.shapes)){ p.shapes.forEach(s=>{ if(typeof s.r==='number')s.r=Math.max(0,Math.min(1,s.r*tr)); if(typeof s.g==='number')s.g=Math.max(0,Math.min(1,s.g*tg)); if(typeof s.b==='number')s.b=Math.max(0,Math.min(1,s.b*tb)); }); }
  return p;
}
edLoad.addEventListener('click', ()=>{
  const name = selPreset.value;
  const base = PRESETS.dict[name];
  if (!base){ alert('Preset not found.'); return; }
  edName.value = name + ' • custom';
  edGamma.value = (typeof base.gamma==='number' ? base.gamma : 1.20).toFixed(2);
  edDecay.value = (typeof base.decay==='number' ? base.decay : 0.985).toFixed(3);
  edR.value = 1.00; edG.value = 1.00; edB.value = 1.00;
  edPerFrame.value = base.per_frame || '';
  edPerPixel.value = base.per_pixel || '';
});
edApply.addEventListener('click', ()=>{
  const baseName = selPreset.value;
  const custom = buildDerivativeFromEditor(baseName);
  if (!custom) return;
  currentPresetName = custom.name;
  viz.loadPreset(custom, Math.max(0, +blendSec.value||0.6));
  if (typeof armWhiteWatch==='function') armWhiteWatch(custom.name);
  PRESETS.dict[custom.name] = custom;
  if (!PRESETS.names.includes(custom.name)) PRESETS.names.push(custom.name);
  console.log('Loaded custom:', custom.name);
});
edDownload.addEventListener('click', ()=>{
  const baseName = selPreset.value;
  const custom = buildDerivativeFromEditor(baseName);
  if (!custom) return;
  const blob = new Blob([JSON.stringify(custom, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (custom.name || 'custom-preset').replace(/[^\w\-.]+/g,'_') + '.json';
  document.body.appendChild(a); a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
});
edMakeCue.addEventListener('click', ()=>{
  const baseName = selPreset.value;
  const custom = buildDerivativeFromEditor(baseName);
  if (!custom) return;
  PRESETS.dict[custom.name] = custom;
  if (!PRESETS.names.includes(custom.name)) PRESETS.names.push(custom.name);
  const barNum = Math.max(1, Math.floor(currentBar()));
  const c = { bar: barNum, name: custom.name, blendSec: Math.max(0, +cueBlend.value||1.2) };
  cues.push(c); renderTimeline(); scheduleCues();
  alert(`Queued "${custom.name}" at bar ${barNum}`);
});

/* ---------- white-out watchdog ---------- */
function armWhiteWatch(presetName){
  if (whiteWatch) { clearInterval(whiteWatch); whiteWatch=null; }
  const pctx = probe.getContext('2d', {willReadFrequently:true}); if(!pctx) return;
  let brightCount=0;
  whiteWatch=setInterval(()=>{
    try{
      pctx.drawImage(canvas, 0,0, probe.width, probe.height);
      const {data} = pctx.getImageData(0,0, probe.width, probe.height);
      let sum=0, n=0;
      for (let i=0;i<data.length;i+=4){
        const r=data[i]/255, g=data[i+1]/255, b=data[i+2]/255;
        sum += 0.2126*r + 0.7152*g + 0.0722*b; n++;
      }
      const avg = sum/n;
      if (avg > 0.97) brightCount++; else brightCount=0;
      if (brightCount >= 3){
        console.log('White-out detected, skipping:', presetName);
        const names = PRESETS.names;
        const i = Math.max(0, names.indexOf(presetName));
        const next = names[(i+1)%names.length];
        loadPresetByName(next, 1.2);
        clearInterval(whiteWatch); whiteWatch=null;
      }
    }catch(e){ clearInterval(whiteWatch); whiteWatch=null; }
  }, 2000);
}

/* ---------- boot ---------- */
function getBC(){
  const bc=window.butterchurn;
  return bc && (typeof bc.createVisualizer==='function' ? bc : bc.default);
}
async function boot(){
  await new Promise(res=>{
    let t=0; const h=setInterval(()=>{ if (window._libsReady){ clearInterval(h); res(); } if (++t>80){ clearInterval(h); res(); } }, 100);
  });
  if (!webglOK()){ alert('WebGL not available. Enable hardware acceleration.'); return false; }
  const BC=getBC(); if (!BC){ alert('Butterchurn failed to load.'); return false; }

  PRESETS = mergePresetPacks();
  fillPresetSelect();
  buildSequencerUI();

  ctx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
  src = ctx.createMediaElementSource(audio);
  const g = ctx.createGain(); g.gain.value=+volEl.value;
  src.connect(ctx.destination); src.connect(g);

  viz = BC.createVisualizer(ctx, canvas, { width: canvas.clientWidth, height: canvas.clientHeight, pixelRatio: 1 });
  viz.connectAudio(g);

  size(); addEventListener('resize', size, {passive:true});
  (function loop(){ viz && viz.render(); requestAnimationFrame(loop); })();

  audio.src = audioSrc.value.trim();
  volEl.oninput = e=> audio.volume=+e.target.value;
  seekEl.oninput = e=>{ if (audio.duration) audio.currentTime = e.target.value*audio.duration; };
  audio.addEventListener('timeupdate', ()=>{
    curEl.textContent = fmt(audio.currentTime||0);
    if (audio.duration){ durEl.textContent = fmt(audio.duration); seekEl.value = (audio.currentTime/audio.duration); }
    barEl.value = Math.max(1, Math.floor(currentBar()));
  });

  // init overlay tint
  updateOverlayTint();

  playBtn.onclick = async ()=>{
    if (!started){
      if (ctx.state==='suspended') await ctx.resume();
      await audio.play();
      started=true;
      loadPresetByName(selPreset.value, 0.0);
      scheduleMicro();
      scheduleCues();
      playBtn.textContent='⏸';
    }else{
      if (audio.paused){ await audio.play(); playBtn.textContent='⏸'; }
      else { audio.pause(); playBtn.textContent='▶'; }
    }
  };

  reloadBtn.onclick = ()=>{
    audio.src = audioSrc.value.trim();
    started=false; playBtn.textContent='▶';
    cues.forEach(c=> delete c._done);
  };
  snap0Btn.onclick = ()=>{ audio.currentTime = 0; };

  document.getElementById('applyNow').onclick = ()=>{
    currentPresetName = selPreset.value;
    applyLiveDebounced();
    updateOverlayTint();
  };
  document.getElementById('previewNext').onclick = ()=> { currentPresetName = selPreset.value; };

  addCueBtn.onclick = ()=>{
    const c = { bar: Math.max(1, parseInt(cueBar.value||1,10)), name: selPreset.value, blendSec: Math.max(0, +cueBlend.value||0) };
    cues.push(c); renderTimeline(); scheduleCues();
  };
  clearCuesBtn.onclick = ()=>{ cues.length=0; renderTimeline(); scheduleCues(); };

  exportBtn.onclick = exportCode;

  return true;
}

/* kick off */
(async function(){
  try{ await boot(); }catch(e){ console.error(e); alert('Init failed. See console.'); }
})();
</script>
</body>
</html>
