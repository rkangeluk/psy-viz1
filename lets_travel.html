<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizer – lets_travel</title>
<style>
  :root{
    --ui-bg: rgba(255,255,255,.88);
    --ui-fg: #3e3e3e;
    --play-oval: rgba(140,195,120,.38);
    --font: 400 12px/22px Clarkson, "Proxima Nova", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  html,body{margin:0;height:100%;background:#000;color:var(--ui-fg);font:var(--font)}

  #vizwrap{position:relative;width:100%;height:100vh;background:#000;overflow:hidden}
  #viz{position:absolute;inset:0;z-index:0;display:block;width:100%;height:100%}

  .starter{
    position:absolute;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,rgba(0,0,0,.30),rgba(0,0,0,.45));
  }
  .play-oval{
    all:unset;cursor:pointer;display:flex;align-items:center;justify-content:center;
    width:112px;height:72px;border-radius:9999px;background:var(--play-oval);
    box-shadow:0 6px 22px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.18)
  }
  .play-oval svg{width:24px;height:24px;fill:#fff}

  .ui{
    position:absolute;left:0;right:0;bottom:0;z-index:10;
    display:flex;align-items:center;gap:.75rem;
    padding:.6rem .8rem;background:var(--ui-bg);color:var(--ui-fg);
    border-top-left-radius:10px;border-top-right-radius:10px;
    opacity:0;transform:translateY(8px);
    transition:opacity .25s ease, transform .25s ease;
    pointer-events:none;
  }
  #vizwrap:hover .ui, #vizwrap.show-ui .ui{
    opacity:1;transform:none;pointer-events:auto;
  }

  .btn{
    all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
    width:36px;height:36px;border-radius:9999px;background:rgba(0,0,0,.06);color:var(--ui-fg)
  }
  .btn:hover{background:rgba(0,0,0,.12)}
  .pill{all:unset;cursor:pointer;background:rgba(0,0,0,.06);padding:.35rem .6rem;border-radius:999px}
  .pill:hover{background:rgba(0,0,0,.12)}
  .label{opacity:.85;min-width:52px;text-align:right}
  .grow{flex:1}.spacer{width:8px}
  input[type="range"]{-webkit-appearance:none;appearance:none;height:4px;width:240px;background:rgba(0,0,0,.18);border-radius:999px;outline:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:#3e3e3e;box-shadow:0 0 0 2px rgba(255,255,255,.8)}

  #probe{position:absolute;left:-9999px;top:-9999px;width:64px;height:64px}
</style>
</head>
<body>
  <div id="vizwrap">
    <canvas id="viz"></canvas>

    <div class="ui">
      <button id="play" class="btn">▶</button>
      <span id="time" class="label">0:00</span>
      <input id="seek" type="range" min="0" max="1" step="0.001" value="0" class="grow"/>
      <span id="dur" class="label">0:00</span>
      <div class="spacer"></div>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:110px"/>
      <div class="spacer"></div>
      <button id="next" class="pill">Next</button>
    </div>

    <div id="starter" class="starter">
      <button id="startBtn" class="play-oval">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
    </div>

    <audio id="player" preload="auto" crossorigin="anonymous"></audio>
    <canvas id="probe" width="64" height="64"></canvas>
  </div>

  <script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurn.min.js"></script>
  <script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurnExtraImages.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js"></script>

<script>
const Q         = new URLSearchParams(location.search);
const AUDIO_URL = Q.get('audio') || 'https://rkangeluk.github.io/psy-viz1/lets_travel.mp3';
const BPM       = +(Q.get('bpm')  || 134);
const BARS      = +(Q.get('bars') || 32);
const SEED      = Q.get('seed')   || 'lets_travel_obscure';
const MS_PER_BAR = (60000 / BPM) * 4;

const wrap=document.getElementById('vizwrap'),canvas=document.getElementById('viz'),
starter=document.getElementById('starter'),startBtn=document.getElementById('startBtn'),
audio=document.getElementById('player'),btnPlay=document.getElementById('play'),
btnNext=document.getElementById('next'),rSeek=document.getElementById('seek'),
rVol=document.getElementById('vol'),tTime=document.getElementById('time'),tDur=document.getElementById('dur');

let ctx,viz,PRESETS={dict:{},names:[]},keys=[],index=0,changeTO=null,changeInterval=null;

const pad=s=>(s<10?'0':'')+s,fmt=t=>!isFinite(t)?'0:00':((t/60)|0)+':'+pad((t%60)|0);
function webglOK(){const c=document.createElement('canvas');return!!(c.getContext('webgl2')||c.getContext('webgl')||c.getContext('experimental-webgl'));}
function size(){const r=wrap.getBoundingClientRect();canvas.width=r.width;canvas.height=r.height;viz&&viz.setRendererSize(r.width,r.height);}
function hintUI(){wrap.classList.add('show-ui');clearTimeout(wrap._h);wrap._h=setTimeout(()=>wrap.classList.remove('show-ui'),1200);}
function seededShuffle(arr,s){let seed=0;for(let i=0;i<s.length;i++)seed=(seed*31+s.charCodeAt(i))>>>0;
function rand(){seed=(1664525*seed+1013904223)>>>0;return(seed&0xfffffff)/0x10000000;}
const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function mergePresetPacks(){
  const libs=[];
  if(window.butterchurnPresets)libs.push((butterchurnPresets.default||butterchurnPresets).getPresets());
  if(window.butterchurnPresetsNonMinimal)libs.push((butterchurnPresetsNonMinimal.default||butterchurnPresetsNonMinimal).getPresets());
  if(window.butterchurnPresetsExtra)libs.push((butterchurnPresetsExtra.default||butterchurnPresetsExtra).getPresets());
  if(window.butterchurnPresetsExtra2)libs.push((butterchurnPresetsExtra2.default||butterchurnPresetsExtra2).getPresets());
  const dict=Object.assign({},...libs),names=Object.keys(dict);return{dict,names};
}

function buildPack(){
  let pool=PRESETS.names;
  const skip=["geiss","yin","milkdrop","flexi","martin","yurop"];
  pool=pool.filter(n=>!skip.some(w=>n.toLowerCase().includes(w)));
  if(!pool.length)pool=PRESETS.names.slice();
  return seededShuffle(pool,SEED).slice(0,1);
}

function getBC(){const bc=window.butterchurn;return bc&&(typeof bc.createVisualizer==='function'?bc:bc.default);}
function loadByIndex(i,blend=1.2){
  if(!keys.length)keys=buildPack();
  index=((i%keys.length)+keys.length)%keys.length;
  viz.loadPreset(PRESETS.dict[keys[index]],blend);
}

function clearCadence(){if(changeTO){clearTimeout(changeTO);changeTO=null;}if(changeInterval){clearInterval(changeInterval);changeInterval=null;}}
function scheduleCadence(){
  clearCadence();if(!audio.duration)return;
  const cur=((audio.currentTime*1000)/MS_PER_BAR)+1;
  const next=((Math.floor((cur-1)/BARS)+1)*BARS)+1;
  changeTO=setTimeout(()=>{loadByIndex(index+1,1.2);
    changeInterval=setInterval(()=>loadByIndex(index+1,1.2),Math.round(MS_PER_BAR*BARS));
  },Math.round(Math.max(0,(next-cur)*MS_PER_BAR)));
}

async function boot(){
  if(!webglOK()){alert("Enable WebGL");return false;}
  PRESETS=mergePresetPacks();if(!PRESETS.names.length)return false;
  const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();
  audio.src=AUDIO_URL;const src=ctx.createMediaElementSource(audio);
  const g=ctx.createGain();g.gain.value=+rVol.value;src.connect(ctx.destination);src.connect(g);
  viz=getBC().createVisualizer(ctx,canvas,{width:canvas.clientWidth,height:canvas.clientHeight,pixelRatio:1});
  viz.connectAudio(g);size();addEventListener("resize",size);
  (function loop(){viz.render();requestAnimationFrame(loop);})();
  rVol.oninput=e=>audio.volume=+e.target.value;
  rSeek.oninput=e=>audio.currentTime=audio.duration*e.target.value;
  audio.ontimeupdate=_=>{tTime.textContent=fmt(audio.currentTime);if(audio.duration)tDur.textContent=fmt(audio.duration),rSeek.value=audio.currentTime/audio.duration;}
  audio.onloadedmetadata=scheduleCadence;
  audio.onseeked=scheduleCadence;
  audio.onplay=scheduleCadence;
  return true;
}

async function startPlayback(){
  if(!ctx){if(!await boot())return;}
  if(ctx.state==="
