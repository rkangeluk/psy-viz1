<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizer – Track 4 (124 BPM, ambient evolving/psy)</title>
<style>
  :root{ --ui-bg: rgba(255,255,255,.88); --ui-fg:#3e3e3e; --play-oval: rgba(140,195,120,.38);
         --font: 400 12px/22px Clarkson,"Proxima Nova","Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif; }
  html,body{margin:0;height:100%;background:#000;color:var(--ui-fg);font:var(--font)}
  #vizwrap{position:relative;width:100%;height:100vh;background:#000;overflow:hidden}
  #viz{position:absolute;inset:0;display:block;width:100%;height:100%}
  .ui{position:absolute;left:0;right:0;bottom:0;display:flex;align-items:center;gap:.75rem;
      padding:.6rem .8rem;background:var(--ui-bg);color:var(--ui-fg);font:var(--font);
      border-top-left-radius:10px;border-top-right-radius:10px;opacity:0;transform:translateY(8px);
      transition:opacity .25s ease, transform .25s ease;pointer-events:none;}
  #vizwrap:hover .ui, #vizwrap.show-ui .ui{opacity:1;transform:none;pointer-events:auto}
  .starter{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
           background:linear-gradient(180deg,rgba(0,0,0,.30),rgba(0,0,0,.45))}
  .play-oval{all:unset;cursor:pointer;display:flex;align-items:center;justify-content:center;
             width:112px;height:72px;border-radius:9999px;background:var(--play-oval);
             box-shadow:0 6px 22px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.18)}
  .play-oval svg{width:24px;height:24px;fill:#fff}
  .btn{all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
       width:36px;height:36px;border-radius:9999px;background:rgba(0,0,0,.06);color:var(--ui-fg)}
  .btn:hover{background:rgba(0,0,0,.12)}
  .pill{all:unset;cursor:pointer;background:rgba(0,0,0,.06);padding:.35rem .6rem;border-radius:999px}
  .pill:hover{background:rgba(0,0,0,.12)}
  .label{opacity:.85;min-width:52px;text-align:right}
  .grow{flex:1}.spacer{width:8px}
  input[type="range"]{-webkit-appearance:none;appearance:none;height:4px;width:240px;background:rgba(0,0,0,.18);
    border-radius:999px;outline:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;
    background:#3e3e3e;box-shadow:0 0 0 2px rgba(255,255,255,.8)}
</style>
</head>
<body>
  <div id="vizwrap" aria-label="Audio visualizer">
    <canvas id="viz"></canvas>

    <div class="ui" role="group" aria-label="Player controls">
      <button id="play" class="btn" aria-label="Play/Pause">▶</button>
      <span id="time" class="label">0:00</span>
      <input id="seek" type="range" min="0" max="1" step="0.001" value="0" class="grow" aria-label="Seek"/>
      <span id="dur" class="label">0:00</span>
      <div class="spacer"></div>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:110px" aria-label="Volume"/>
      <div class="spacer"></div>
      <button id="next" class="pill" aria-label="Next preset">Next</button>
    </div>

    <div id="starter" class="starter" role="dialog" aria-label="Click to start">
      <button id="startBtn" class="play-oval" aria-label="Play" onclick="window._vizStart && window._vizStart()">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
      </button>
    </div>

    <audio id="player" preload="auto" playsinline crossorigin="anonymous"></audio>
  </div>

  <script>
  // --- small sequential loader with jsDelivr fallback ---
  function loadScriptPair(primary, fallback){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src=primary; s.async=false;
      s.onload=()=>resolve();
      s.onerror=()=>{ const f=document.createElement('script'); f.src=fallback; f.async=false; f.onload=()=>resolve(); f.onerror=()=>reject(new Error('CDN fail')); document.head.appendChild(f); };
      document.head.appendChild(s);
    });
  }
  (async function loadLibs(){
    const u='https://unpkg.com/', j='https://cdn.jsdelivr.net/npm/';
    await loadScriptPair(u+'butterchurn@2.6.7/lib/butterchurn.min.js',              j+'butterchurn@2.6.7/lib/butterchurn.min.js');
    await loadScriptPair(u+'butterchurn@2.6.7/lib/butterchurnExtraImages.min.js',   j+'butterchurn@2.6.7/lib/butterchurnExtraImages.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js',        j+'butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js', j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js',   j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js',  j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js');
    boot(); // start after libs
  })();
  </script>

  <script>
  // ===== params =====
  const url = new URL(location.href);
  const P = (k,d)=>url.searchParams.get(k)||d;

  const AUDIO_FILE = P('audio','track4.mp3');
  const BPM        = parseFloat(P('bpm','124'));
  const BARS       = parseInt(P('bars','194'),10);
  const MICRO      = parseInt(P('micro','8'),10);
  const MACRO      = parseInt(P('macro','24'),10);
  const BLOOM_BAR  = parseInt(P('bloom','160'),10);
  const SEED       = P('seed','track4-ambient-evolving');
  const BAN_PARAM  = P('ban','');

  // ===== DOM =====
  const wrap=document.getElementById('vizwrap'), canvas=document.getElementById('viz');
  const starter=document.getElementById('starter'), startBtn=document.getElementById('startBtn');
  const audio=document.getElementById('player'), btnPlay=document.getElementById('play'), btnNext=document.getElementById('next');
  const rSeek=document.getElementById('seek'), rVol=document.getElementById('vol'), tTime=document.getElementById('time'), tDur=document.getElementById('dur');
  audio.src=AUDIO_FILE;

  // ===== helpers =====
  const pad=s=>(s<10?'0':'')+s;
  const fmt=t=>(!isFinite(t)?'0:00':((t/60)|0)+':'+pad((t%60)|0));
  const MS_PER_BAR=(60000/BPM)*4, msForBars=b=>Math.round(MS_PER_BAR*b);
  function webglOK(){ const c=document.createElement('canvas'); return !!(c.getContext('webgl2')||c.getContext('webgl')||c.getContext('experimental-webgl')); }
  function seededShuffle(arr, seedStr){
    let seed=0; for(let i=0;i<seedStr.length;i++) seed=(seed*31+seedStr.charCodeAt(i))>>>0;
    function rnd(){ seed=(1664525*seed+1013904223)>>>0; return (seed&0xfffffff)/0x10000000; }
    const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a;
  }

  // ===== state =====
  let ctx, src, viz, PRESETS={dict:{},names:[]};
  let keys=[], index=0, phase='A', bloomArmed=true;
  let microTimer=null, macroTimer=null;

  // ===== packs =====
  const BASE_BLOCK=new Set(['Geiss - Desert Rose']);
  const USER_BLOCK=new Set(BAN_PARAM?BAN_PARAM.split(',').map(s=>s.trim()).filter(Boolean):[]);

  function mergePresetPacks(){
    const libs=[];
    if (window.butterchurnPresets) libs.push((butterchurnPresets.default||butterchurnPresets).getPresets());
    if (window.butterchurnPresetsNonMinimal) libs.push((butterchurnPresetsNonMinimal.default||butterchurnPresetsNonMinimal).getPresets());
    if (window.butterchurnPresetsExtra) libs.push((butterchurnPresetsExtra.default||butterchurnPresetsExtra).getPresets());
    if (window.butterchurnPresetsExtra2) libs.push((butterchurnPresetsExtra2.default||butterchurnPresetsExtra2).getPresets());
    const dict=Object.assign({},...libs), names=Object.keys(dict);
    return {dict,names};
  }
  function buildPack(){
    const names=PRESETS.names;
    const re=/(cloud|nebula|aura|aurora|mist|plasma|fluid|flow|wave|sea|water|kaleid|spiral|vortex|wormhole|fractal|bloom|pulse|ribbon|lace|glow|minimal|lofi|mono|soft|blur|psy|tunnel|chroma)/i;
    let pool=names.filter(n=>re.test(n) && !BASE_BLOCK.has(n) && !USER_BLOCK.has(n));
    if (pool.length<16) pool=names.filter(n=>!BASE_BLOCK.has(n) && !USER_BLOCK.has(n));
    if (pool.length<8)  pool=names;
    return seededShuffle(pool, SEED);
  }

  // ===== sizing =====
  function size(){ const r=wrap.getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height; viz && viz.setRendererSize(r.width,r.height); }

  // ===== psychedelic evolution =====
  function mutatePreset(base, tMs, intensity=1){
    const p=JSON.parse(JSON.stringify(base));
    p.ob_a=0; p.ib_a=0;
    const s = Math.sin(tMs*0.00035)*0.5+0.5, s2= Math.sin(tMs*0.00021+1.57)*0.5+0.5;
    p.decay=Math.min(0.996, 0.986 + 0.012*s*0.7*intensity);
    p.gamma=1.06 + 0.16*s2*0.7*intensity;
    p.per_frame=(p.per_frame||"")+"q1=0.92*q1+0.08*bass_att; q2=0.94*q2+0.06*mid_att; rot=rot+0.0010*sin(time*0.22)+0.0006*(q1-0.4); zoom=zoom*(1.0+0.006*sin(time*0.30)+0.004*(q2-0.3)); warp=0.015+0.010*sin(time*0.18); cx=0.5+0.08*sin(time*0.11); cy=0.5+0.08*cos(time*0.09); ";
    if (phase==='B'){ p.per_frame+="rot=rot+0.0008; zoom=zoom*(1.0+0.008*sin(time*0.41)); warp=0.020;"; }
    return p;
  }

  function tryLoadName(name, blend){
    try{
      const base=PRESETS.dict[name]; if(!base) throw new Error('missing '+name);
      const tMs=(audio.currentTime||0)*1000;
      viz.loadPreset(mutatePreset(base, tMs, phase==='B'?1.2:1.0), blend);
      wrap.classList.add('show-ui'); clearTimeout(wrap._h); wrap._h=setTimeout(()=>wrap.classList.remove('show-ui'),800);
      return true;
    }catch(e){ console.warn('preset fail', name, e); return false; }
  }
  function loadByIndex(i, blend=1.0){
    if (!keys.length) keys=buildPack();
    index=((i%keys.length)+keys.length)%keys.length;
    let tries=0, ok=false;
    while(tries<Math.min(6,keys.length) && !(ok=tryLoadName(keys[index], blend))){ index=(index+1)%keys.length; tries++; }
    if (!ok){
      PRESETS=mergePresetPacks(); keys=buildPack(); index=index%keys.length;
      if (!tryLoadName(keys[index], 0.0) && window.butterchurnPresets){
        const core=(butterchurnPresets.default||butterchurnPresets).getPresets();
        PRESETS={dict:core, names:Object.keys(core)};
        keys=PRESETS.names.filter(n=>!BASE_BLOCK.has(n) && !USER_BLOCK.has(n)); index=index%keys.length;
        tryLoadName(keys[index], 0.0);
      }
    }
  }

  function clearTimers(){ if(microTimer){clearInterval(microTimer); microTimer=null;} if(macroTimer){clearInterval(macroTimer); macroTimer=null;} }
  function scheduleEvolving(){
    clearTimers();
    microTimer=setInterval(()=> loadByIndex(index, 1.0), msForBars(MICRO));   // 1.0s morph
    macroTimer=setInterval(()=> loadByIndex(index+1, 2.2), msForBars(MACRO)); // 2.2s crossfade
  }

  function buildVizInput(c, mediaSource){
    mediaSource.connect(c.destination);
    const g=c.createGain(); g.gain.value=+rVol.value;
    mediaSource.connect(g);
    return g;
  }

  async function boot(){
    if (!webglOK()){ alert('WebGL not available. Enable hardware acceleration.'); return; }
    const BC=(window.butterchurn && (butterchurn.createVisualizer?butterchurn:butterchurn.default))||null;
    const merged=mergePresetPacks(); if(!BC || !merged.names.length){ alert('Preset libraries failed to load.'); return; }
    PRESETS=merged;

    if (!ctx){
      ctx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
      src=ctx.createMediaElementSource(audio);
      viz=BC.createVisualizer(ctx, canvas, { width: canvas.clientWidth, height: canvas.clientHeight, pixelRatio: 1 });
      viz.connectAudio(buildVizInput(ctx, src));

      keys=buildPack();
      index=Math.min(1, Math.max(0, keys.length-1));
      phase='A'; bloomArmed=true;
      loadByIndex(index, 0.0);

      (function loop(){ viz.render(); requestAnimationFrame(loop); })();
      size(); addEventListener('resize', size, {passive:true});

      scheduleEvolving();

      let lastT=0;
      audio.addEventListener('timeupdate', ()=>{
        const t=audio.currentTime||0;
        if (audio.duration){ rSeek.value=t/audio.duration; tTime.textContent=fmt(t); tDur.textContent=fmt(audio.duration); }
        if (bloomArmed && t*1000 >= msForBars(BLOOM_BAR)){ phase='B'; bloomArmed=false; loadByIndex(index, 1.2); }
        if (t<1 && lastT>5){ keys=buildPack(); index=Math.min(1, keys.length-1); phase='A'; bloomArmed=true; loadByIndex(index, 0.0); scheduleEvolving(); }
        lastT=t;
      }, {passive:true});
    }
    if (ctx.state==='suspended'){ await ctx.resume(); }
  }

  // robust starter: any interaction
  window._vizStart = async function(){
    try{ if(!ctx) await boot(); if (ctx.state==='suspended') await ctx.resume(); await audio.play(); starter.style.display='none'; btnPlay.textContent='⏸'; }
    catch(e){ console.error('play failed', e, 'src=', audio.currentSrc); alert('Could not start audio. Check the file URL/name and try again.'); }
  };
  document.addEventListener('pointerdown', ()=>{ if(!ctx){ window._vizStart(); } }, {once:true, passive:true});
  document.addEventListener('keydown', e=>{ if(e.code==='Space'||e.key==='Enter') window._vizStart(); });
  startBtn.addEventListener('click', ()=> window._vizStart());
  document.getElementById('viz').addEventListener('click', ()=> window._vizStart());

  // controls
  document.getElementById('play').addEventListener('click', async ()=>{
    try{ if(!ctx) await boot(); if(audio.paused){ await audio.play(); this.textContent='⏸'; } else { audio.pause(); this.textContent='▶'; } }
    catch(e){ console.error(e); alert('Could not start audio.'); }
  });
  document.getElementById('next').addEventListener('click', ()=> loadByIndex(index+1, 1.4));
  rSeek.addEventListener('input', e=>{ if(audio.duration) audio.currentTime = e.target.value * audio.duration; });
  rVol.addEventListener('input', e=>{ audio.volume = +e.target.value; });
  </script>
</body>
</html>
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizer – Track 4 (124 BPM, ambient evolving/psy)</title>
<style>
  :root{ --ui-bg: rgba(255,255,255,.88); --ui-fg:#3e3e3e; --play-oval: rgba(140,195,120,.38);
         --font: 400 12px/22px Clarkson,"Proxima Nova","Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif; }
  html,body{margin:0;height:100%;background:#000;color:var(--ui-fg);font:var(--font)}
  #vizwrap{position:relative;width:100%;height:100vh;background:#000;overflow:hidden}
  #viz{position:absolute;inset:0;display:block;width:100%;height:100%}
  .ui{position:absolute;left:0;right:0;bottom:0;display:flex;align-items:center;gap:.75rem;
      padding:.6rem .8rem;background:var(--ui-bg);color:var(--ui-fg);font:var(--font);
      border-top-left-radius:10px;border-top-right-radius:10px;opacity:0;transform:translateY(8px);
      transition:opacity .25s ease, transform .25s ease;pointer-events:none;}
  #vizwrap:hover .ui, #vizwrap.show-ui .ui{opacity:1;transform:none;pointer-events:auto}
  .starter{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
           background:linear-gradient(180deg,rgba(0,0,0,.30),rgba(0,0,0,.45))}
  .play-oval{all:unset;cursor:pointer;display:flex;align-items:center;justify-content:center;
             width:112px;height:72px;border-radius:9999px;background:var(--play-oval);
             box-shadow:0 6px 22px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.18)}
  .play-oval svg{width:24px;height:24px;fill:#fff}
  .btn{all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
       width:36px;height:36px;border-radius:9999px;background:rgba(0,0,0,.06);color:var(--ui-fg)}
  .btn:hover{background:rgba(0,0,0,.12)}
  .pill{all:unset;cursor:pointer;background:rgba(0,0,0,.06);padding:.35rem .6rem;border-radius:999px}
  .pill:hover{background:rgba(0,0,0,.12)}
  .label{opacity:.85;min-width:52px;text-align:right}
  .grow{flex:1}.spacer{width:8px}
  input[type="range"]{-webkit-appearance:none;appearance:none;height:4px;width:240px;background:rgba(0,0,0,.18);
    border-radius:999px;outline:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;
    background:#3e3e3e;box-shadow:0 0 0 2px rgba(255,255,255,.8)}
</style>
</head>
<body>
  <div id="vizwrap" aria-label="Audio visualizer">
    <canvas id="viz"></canvas>

    <div class="ui" role="group" aria-label="Player controls">
      <button id="play" class="btn" aria-label="Play/Pause">▶</button>
      <span id="time" class="label">0:00</span>
      <input id="seek" type="range" min="0" max="1" step="0.001" value="0" class="grow" aria-label="Seek"/>
      <span id="dur" class="label">0:00</span>
      <div class="spacer"></div>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:110px" aria-label="Volume"/>
      <div class="spacer"></div>
      <button id="next" class="pill" aria-label="Next preset">Next</button>
    </div>

    <div id="starter" class="starter" role="dialog" aria-label="Click to start">
      <button id="startBtn" class="play-oval" aria-label="Play" onclick="window._vizStart && window._vizStart()">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
      </button>
    </div>

    <audio id="player" preload="auto" playsinline crossorigin="anonymous"></audio>
  </div>

  <script>
  // --- small sequential loader with jsDelivr fallback ---
  function loadScriptPair(primary, fallback){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src=primary; s.async=false;
      s.onload=()=>resolve();
      s.onerror=()=>{ const f=document.createElement('script'); f.src=fallback; f.async=false; f.onload=()=>resolve(); f.onerror=()=>reject(new Error('CDN fail')); document.head.appendChild(f); };
      document.head.appendChild(s);
    });
  }
  (async function loadLibs(){
    const u='https://unpkg.com/', j='https://cdn.jsdelivr.net/npm/';
    await loadScriptPair(u+'butterchurn@2.6.7/lib/butterchurn.min.js',              j+'butterchurn@2.6.7/lib/butterchurn.min.js');
    await loadScriptPair(u+'butterchurn@2.6.7/lib/butterchurnExtraImages.min.js',   j+'butterchurn@2.6.7/lib/butterchurnExtraImages.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js',        j+'butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js', j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js',   j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js',  j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js');
    boot(); // start after libs
  })();
  </script>

  <script>
  // ===== params =====
  const url = new URL(location.href);
  const P = (k,d)=>url.searchParams.get(k)||d;

  const AUDIO_FILE = P('audio','track4.mp3');
  const BPM        = parseFloat(P('bpm','124'));
  const BARS       = parseInt(P('bars','194'),10);
  const MICRO      = parseInt(P('micro','8'),10);
  const MACRO      = parseInt(P('macro','24'),10);
  const BLOOM_BAR  = parseInt(P('bloom','160'),10);
  const SEED       = P('seed','track4-ambient-evolving');
  const BAN_PARAM  = P('ban','');

  // ===== DOM =====
  const wrap=document.getElementById('vizwrap'), canvas=document.getElementById('viz');
  const starter=document.getElementById('starter'), startBtn=document.getElementById('startBtn');
  const audio=document.getElementById('player'), btnPlay=document.getElementById('play'), btnNext=document.getElementById('next');
  const rSeek=document.getElementById('seek'), rVol=document.getElementById('vol'), tTime=document.getElementById('time'), tDur=document.getElementById('dur');
  audio.src=AUDIO_FILE;

  // ===== helpers =====
  const pad=s=>(s<10?'0':'')+s;
  const fmt=t=>(!isFinite(t)?'0:00':((t/60)|0)+':'+pad((t%60)|0));
  const MS_PER_BAR=(60000/BPM)*4, msForBars=b=>Math.round(MS_PER_BAR*b);
  function webglOK(){ const c=document.createElement('canvas'); return !!(c.getContext('webgl2')||c.getContext('webgl')||c.getContext('experimental-webgl')); }
  function seededShuffle(arr, seedStr){
    let seed=0; for(let i=0;i<seedStr.length;i++) seed=(seed*31+seedStr.charCodeAt(i))>>>0;
    function rnd(){ seed=(1664525*seed+1013904223)>>>0; return (seed&0xfffffff)/0x10000000; }
    const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a;
  }

  // ===== state =====
  let ctx, src, viz, PRESETS={dict:{},names:[]};
  let keys=[], index=0, phase='A', bloomArmed=true;
  let microTimer=null, macroTimer=null;

  // ===== packs =====
  const BASE_BLOCK=new Set(['Geiss - Desert Rose']);
  const USER_BLOCK=new Set(BAN_PARAM?BAN_PARAM.split(',').map(s=>s.trim()).filter(Boolean):[]);

  function mergePresetPacks(){
    const libs=[];
    if (window.butterchurnPresets) libs.push((butterchurnPresets.default||butterchurnPresets).getPresets());
    if (window.butterchurnPresetsNonMinimal) libs.push((butterchurnPresetsNonMinimal.default||butterchurnPresetsNonMinimal).getPresets());
    if (window.butterchurnPresetsExtra) libs.push((butterchurnPresetsExtra.default||butterchurnPresetsExtra).getPresets());
    if (window.butterchurnPresetsExtra2) libs.push((butterchurnPresetsExtra2.default||butterchurnPresetsExtra2).getPresets());
    const dict=Object.assign({},...libs), names=Object.keys(dict);
    return {dict,names};
  }
  function buildPack(){
    const names=PRESETS.names;
    const re=/(cloud|nebula|aura|aurora|mist|plasma|fluid|flow|wave|sea|water|kaleid|spiral|vortex|wormhole|fractal|bloom|pulse|ribbon|lace|glow|minimal|lofi|mono|soft|blur|psy|tunnel|chroma)/i;
    let pool=names.filter(n=>re.test(n) && !BASE_BLOCK.has(n) && !USER_BLOCK.has(n));
    if (pool.length<16) pool=names.filter(n=>!BASE_BLOCK.has(n) && !USER_BLOCK.has(n));
    if (pool.length<8)  pool=names;
    return seededShuffle(pool, SEED);
  }

  // ===== sizing =====
  function size(){ const r=wrap.getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height; viz && viz.setRendererSize(r.width,r.height); }

  // ===== psychedelic evolution =====
  function mutatePreset(base, tMs, intensity=1){
    const p=JSON.parse(JSON.stringify(base));
    p.ob_a=0; p.ib_a=0;
    const s = Math.sin(tMs*0.00035)*0.5+0.5, s2= Math.sin(tMs*0.00021+1.57)*0.5+0.5;
    p.decay=Math.min(0.996, 0.986 + 0.012*s*0.7*intensity);
    p.gamma=1.06 + 0.16*s2*0.7*intensity;
    p.per_frame=(p.per_frame||"")+"q1=0.92*q1+0.08*bass_att; q2=0.94*q2+0.06*mid_att; rot=rot+0.0010*sin(time*0.22)+0.0006*(q1-0.4); zoom=zoom*(1.0+0.006*sin(time*0.30)+0.004*(q2-0.3)); warp=0.015+0.010*sin(time*0.18); cx=0.5+0.08*sin(time*0.11); cy=0.5+0.08*cos(time*0.09); ";
    if (phase==='B'){ p.per_frame+="rot=rot+0.0008; zoom=zoom*(1.0+0.008*sin(time*0.41)); warp=0.020;"; }
    return p;
  }

  function tryLoadName(name, blend){
    try{
      const base=PRESETS.dict[name]; if(!base) throw new Error('missing '+name);
      const tMs=(audio.currentTime||0)*1000;
      viz.loadPreset(mutatePreset(base, tMs, phase==='B'?1.2:1.0), blend);
      wrap.classList.add('show-ui'); clearTimeout(wrap._h); wrap._h=setTimeout(()=>wrap.classList.remove('show-ui'),800);
      return true;
    }catch(e){ console.warn('preset fail', name, e); return false; }
  }
  function loadByIndex(i, blend=1.0){
    if (!keys.length) keys=buildPack();
    index=((i%keys.length)+keys.length)%keys.length;
    let tries=0, ok=false;
    while(tries<Math.min(6,keys.length) && !(ok=tryLoadName(keys[index], blend))){ index=(index+1)%keys.length; tries++; }
    if (!ok){
      PRESETS=mergePresetPacks(); keys=buildPack(); index=index%keys.length;
      if (!tryLoadName(keys[index], 0.0) && window.butterchurnPresets){
        const core=(butterchurnPresets.default||butterchurnPresets).getPresets();
        PRESETS={dict:core, names:Object.keys(core)};
        keys=PRESETS.names.filter(n=>!BASE_BLOCK.has(n) && !USER_BLOCK.has(n)); index=index%keys.length;
        tryLoadName(keys[index], 0.0);
      }
    }
  }

  function clearTimers(){ if(microTimer){clearInterval(microTimer); microTimer=null;} if(macroTimer){clearInterval(macroTimer); macroTimer=null;} }
  function scheduleEvolving(){
    clearTimers();
    microTimer=setInterval(()=> loadByIndex(index, 1.0), msForBars(MICRO));   // 1.0s morph
    macroTimer=setInterval(()=> loadByIndex(index+1, 2.2), msForBars(MACRO)); // 2.2s crossfade
  }

  function buildVizInput(c, mediaSource){
    mediaSource.connect(c.destination);
    const g=c.createGain(); g.gain.value=+rVol.value;
    mediaSource.connect(g);
    return g;
  }

  async function boot(){
    if (!webglOK()){ alert('WebGL not available. Enable hardware acceleration.'); return; }
    const BC=(window.butterchurn && (butterchurn.createVisualizer?butterchurn:butterchurn.default))||null;
    const merged=mergePresetPacks(); if(!BC || !merged.names.length){ alert('Preset libraries failed to load.'); return; }
    PRESETS=merged;

    if (!ctx){
      ctx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
      src=ctx.createMediaElementSource(audio);
      viz=BC.createVisualizer(ctx, canvas, { width: canvas.clientWidth, height: canvas.clientHeight, pixelRatio: 1 });
      viz.connectAudio(buildVizInput(ctx, src));

      keys=buildPack();
      index=Math.min(1, Math.max(0, keys.length-1));
      phase='A'; bloomArmed=true;
      loadByIndex(index, 0.0);

      (function loop(){ viz.render(); requestAnimationFrame(loop); })();
      size(); addEventListener('resize', size, {passive:true});

      scheduleEvolving();

      let lastT=0;
      audio.addEventListener('timeupdate', ()=>{
        const t=audio.currentTime||0;
        if (audio.duration){ rSeek.value=t/audio.duration; tTime.textContent=fmt(t); tDur.textContent=fmt(audio.duration); }
        if (bloomArmed && t*1000 >= msForBars(BLOOM_BAR)){ phase='B'; bloomArmed=false; loadByIndex(index, 1.2); }
        if (t<1 && lastT>5){ keys=buildPack(); index=Math.min(1, keys.length-1); phase='A'; bloomArmed=true; loadByIndex(index, 0.0); scheduleEvolving(); }
        lastT=t;
      }, {passive:true});
    }
    if (ctx.state==='suspended'){ await ctx.resume(); }
  }

  // robust starter: any interaction
  window._vizStart = async function(){
    try{ if(!ctx) await boot(); if (ctx.state==='suspended') await ctx.resume(); await audio.play(); starter.style.display='none'; btnPlay.textContent='⏸'; }
    catch(e){ console.error('play failed', e, 'src=', audio.currentSrc); alert('Could not start audio. Check the file URL/name and try again.'); }
  };
  document.addEventListener('pointerdown', ()=>{ if(!ctx){ window._vizStart(); } }, {once:true, passive:true});
  document.addEventListener('keydown', e=>{ if(e.code==='Space'||e.key==='Enter') window._vizStart(); });
  startBtn.addEventListener('click', ()=> window._vizStart());
  document.getElementById('viz').addEventListener('click', ()=> window._vizStart());

  // controls
  document.getElementById('play').addEventListener('click', async ()=>{
    try{ if(!ctx) await boot(); if(audio.paused){ await audio.play(); this.textContent='⏸'; } else { audio.pause(); this.textContent='▶'; } }
    catch(e){ console.error(e); alert('Could not start audio.'); }
  });
  document.getElementById('next').addEventListener('click', ()=> loadByIndex(index+1, 1.4));
  rSeek.addEventListener('input', e=>{ if(audio.duration) audio.currentTime = e.target.value * audio.duration; });
  rVol.addEventListener('input', e=>{ audio.volume = +e.target.value; });
  </script>
</body>
</html>
