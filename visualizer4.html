<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizer – Track 4 (124 BPM, ambient evolving/psy)</title>
<style>
  :root{
    --ui-bg: rgba(255,255,255,.88);
    --ui-fg: #3e3e3e;
    --play-oval: rgba(140, 195, 120, .38);
    --font: 400 12px/22px Clarkson, "Proxima Nova", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  html,body{margin:0;height:100%;background:#000;color:var(--ui-fg);font:var(--font)}
  #vizwrap{position:relative;width:100%;height:100vh;background:#000;overflow:hidden}
  #viz{position:absolute;inset:0;display:block;width:100%;height:100%}

  /* Hover-only controls */
  .ui{
    position:absolute;left:0;right:0;bottom:0;display:flex;align-items:center;gap:.75rem;
    padding:.6rem .8rem;background:var(--ui-bg);color:var(--ui-fg);font:var(--font);
    border-top-left-radius:10px;border-top-right-radius:10px;opacity:0;transform:translateY(8px);
    transition:opacity .25s ease, transform .25s ease;pointer-events:none;
  }
  #vizwrap:hover .ui, #vizwrap.show-ui .ui{opacity:1;transform:none;pointer-events:auto}

  /* Starter overlay */
  .starter{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,rgba(0,0,0,.30),rgba(0,0,0,.45));
  }
  .play-oval{
    all:unset;cursor:pointer;display:flex;align-items:center;justify-content:center;
    width:112px;height:72px;border-radius:9999px;background:var(--play-oval);
    box-shadow:0 6px 22px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.18);
  }
  .play-oval svg{width:24px;height:24px;fill:#fff}

  .btn{
    all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
    width:36px;height:36px;border-radius:9999px;background:rgba(0,0,0,.06);color:var(--ui-fg)
  }
  .btn:hover{background:rgba(0,0,0,.12)}
  .pill{all:unset;cursor:pointer;background:rgba(0,0,0,.06);padding:.35rem .6rem;border-radius:999px}
  .pill:hover{background:rgba(0,0,0,.12)}
  .label{opacity:.85;min-width:52px;text-align:right}
  .grow{flex:1}
  .spacer{width:8px}
  input[type="range"]{
    -webkit-appearance:none;appearance:none;height:4px;width:240px;background:rgba(0,0,0,.18);
    border-radius:999px;outline:none
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;
    background:#3e3e3e;box-shadow:0 0 0 2px rgba(255,255,255,.8)
  }
</style>
</head>
<body>
  <div id="vizwrap" aria-label="Audio visualizer">
    <canvas id="viz"></canvas>

    <div class="ui" role="group" aria-label="Player controls">
      <button id="play" class="btn" aria-label="Play/Pause">▶</button>
      <span id="time" class="label">0:00</span>
      <input id="seek" type="range" min="0" max="1" step="0.001" value="0" class="grow" aria-label="Seek"/>
      <span id="dur" class="label">0:00</span>
      <div class="spacer"></div>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:110px" aria-label="Volume"/>
      <div class="spacer"></div>
      <button id="next" class="pill" aria-label="Next preset">Next</button>
    </div>

    <!-- Inline onclick so nothing can swallow the first start -->
    <div id="starter" class="starter" role="dialog" aria-label="Click to start">
      <button id="startBtn" class="play-oval" aria-label="Play" onclick="window._vizStart && window._vizStart()">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
      </button>
    </div>

    <!-- Audio from URL or default -->
    <audio id="player" preload="auto" playsinline crossorigin="anonymous"></audio>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurn.min.js"></script>
  <script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurnExtraImages.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js"></script>

  <script>
  /* ===== URL params ===== */
  const url = new URL(location.href);
  const P = (k, d) => url.searchParams.get(k) || d;

  const AUDIO_FILE = P('audio','track4.mp3');
  const BPM        = parseFloat(P('bpm','124'));
  const BARS       = parseInt(P('bars','194'),10);
  const MICRO      = parseInt(P('micro','8'),10);   // bars between micro mutations
  const MACRO      = parseInt(P('macro','24'),10);  // bars between preset changes
  const BLOOM_BAR  = parseInt(P('bloom','160'),10); // late bloom start
  const SEED       = P('seed','track4-ambient-evolving');
  const BAN_PARAM  = P('ban','');                   // optional: comma-separated preset names to exclude

  /* ===== DOM ===== */
  const wrap=document.getElementById('vizwrap'), canvas=document.getElementById('viz');
  const starter=document.getElementById('starter'), startBtn=document.getElementById('startBtn');
  const audio=document.getElementById('player'), btnPlay=document.getElementById('play'), btnNext=document.getElementById('next');
  const rSeek=document.getElementById('seek'), rVol=document.getElementById('vol'), tTime=document.getElementById('time'), tDur=document.getElementById('dur');
  audio.src = AUDIO_FILE;

  /* ===== helpers ===== */
  const pad = s => (s<10?'0':'')+s;
  const fmt = t => (!isFinite(t)?'0:00': ((t/60)|0)+':'+pad((t%60)|0));
  const MS_PER_BAR = (60000 / BPM) * 4;
  const msForBars = b => Math.round(MS_PER_BAR * b);
  function webglOK(){ const c=document.createElement('canvas'); return !!(c.getContext('webgl2')||c.getContext('webgl')||c.getContext('experimental-webgl')); }
  function seededShuffle(arr, seedStr){
    let seed=0; for(let i=0;i<seedStr.length;i++) seed=(seed*31 + seedStr.charCodeAt(i))>>>0;
    function rnd(){ seed=(1664525*seed+1013904223)>>>0; return (seed & 0xffff*
