<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizer – Track 4 (ambient evolving, 16-bar grid)</title>
<style>
  :root{
    --ui-bg: rgba(255,255,255,.88);
    --ui-fg:#3e3e3e;
    --play-oval: rgba(140,195,120,.38);
    --font: 400 12px/22px Clarkson,"Proxima Nova","Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
  }
  html,body{margin:0;height:100%;background:#000;color:var(--ui-fg);font:var(--font)}
  #vizwrap{position:relative;width:100%;height:100vh;background:#000;overflow:hidden}
  #viz{position:absolute;inset:0;display:block;width:100%;height:100%}
  .ui{
    position:absolute;left:0;right:0;bottom:0;display:flex;align-items:center;gap:.75rem;
    padding:.6rem .8rem;background:var(--ui-bg);color:var(--ui-fg);font:var(--font);
    border-top-left-radius:10px;border-top-right-radius:10px;
    opacity:0;transform:translateY(8px);
    transition:opacity .25s ease, transform .25s ease;
    pointer-events:none;
  }
  #vizwrap:hover .ui{opacity:1;transform:none;pointer-events:auto}

  /* Starter overlay – shared cover for streaming tracks */
  .starter{
    position:absolute;
    inset:0;
    z-index:20;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:32px;
    background:
      linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55)),
      url('https://rkangeluk.github.io/psy-viz1/covers/psy_cover.jpeg')
        center center / cover no-repeat;
  }

  /* Track title for streaming version */
  .track-title{
    font-size:clamp(26px, 3.4vw, 36px);
    font-weight:400;
    color:#ffffff;
    text-shadow:0 2px 12px rgba(0,0,0,0.9);
  }

  /* Play button – slightly larger oval for streaming view */
  .play-oval{
    all:unset;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    width:140px;
    height:50px;
    padding:0 14px;
    border-radius:9999px;
    background:rgba(197,203,157,0.78);
    border:2px solid #6e7f3d;
    box-shadow:0 6px 22px rgba(0,0,0,0.35);
  }
  .play-oval svg{
    width:20px;
    height:20px;
    fill:#486020;
  }

  .btn{
    all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
    width:36px;height:36px;border-radius:9999px;background:rgba(0,0,0,.06);color:var(--ui-fg)
  }
  .btn:hover{background:rgba(0,0,0,.12)}
  .pill{all:unset;cursor:pointer;background:rgba(0,0,0,.06);padding:.35rem .6rem;border-radius:999px}
  .pill:hover{background:rgba(0,0,0,.12)}
  .label{opacity:.85;min-width:52px;text-align:right}
  .grow{flex:1}.spacer{width:8px}
  input[type="range"]{
    -webkit-appearance:none;appearance:none;
    height:4px;width:240px;background:rgba(0,0,0,.18);
    border-radius:999px;outline:none
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;
    width:14px;height:14px;border-radius:50%;
    background:#3e3e3e;box-shadow:0 0 0 2px rgba(255,255,255,.8)
  }
  #probe{position:absolute;left:-9999px;top:-9999px;width:64px;height:64px}
</style>
</head>
<body>
  <div id="vizwrap" aria-label="Audio visualizer">
    <canvas id="viz"></canvas>
    <canvas id="probe" width="64" height="64" aria-hidden="true"></canvas>

    <div class="ui" role="group" aria-label="Player controls">
      <button id="play" class="btn" aria-label="Play/Pause">▶</button>
      <span id="time" class="label">0:00</span>
      <input id="seek" type="range" min="0" max="1" step="0.001" value="0" class="grow" aria-label="Seek"/>
      <span id="dur" class="label">0:00</span>
      <div class="spacer"></div>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:110px" aria-label="Volume"/>
      <div class="spacer"></div>
    </div>

    <div id="starter" class="starter" role="dialog" aria-label="Click to start">
      <div class="track-title">Esser lieto</div>
      <button id="startBtn" class="play-oval" aria-label="Play" type="button">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </button>
    </div>

    <audio id="player" preload="auto" playsinline crossorigin="anonymous"></audio>
  </div>

  <!-- libs with jsDelivr fallback -->
  <script>
  function loadScriptPair(primary, fallback){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src=primary; s.async=false;
      s.onload=resolve;
      s.onerror=()=>{
        const f=document.createElement('script');
        f.src=fallback; f.async=false;
        f.onload=resolve;
        f.onerror=()=>reject(new Error('CDN fail '+primary));
        document.head.appendChild(f);
      };
      document.head.appendChild(s);
    });
  }
  (async function libs(){
    const u='https://unpkg.com/', j='https://cdn.jsdelivr.net/npm/';
    await loadScriptPair(u+'butterchurn@2.6.7/lib/butterchurn.min.js',              j+'butterchurn@2.6.7/lib/butterchurn.min.js');
    await loadScriptPair(u+'butterchurn@2.6.7/lib/butterchurnExtraImages.min.js',   j+'butterchurn@2.6.7/lib/butterchurnExtraImages.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js',        j+'butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js', j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js',   j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js');
    await loadScriptPair(u+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js',  j+'butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js');
    window._libsReady = true;
  })();
  </script>

  <script>
  /* params (16-bar macro default) */
  const url = new URL(location.href);
  const P = (k,d)=>url.searchParams.get(k)||d;
  const AUDIO_FILE = P('audio','track4.mp3');
  const BPM        = parseFloat(P('bpm','124'));
  const BARS       = parseInt(P('bars','194'),10);
  const MICRO      = parseInt(P('micro','4'),10);     // micro morphs: 4 bars
  const MACRO      = parseInt(P('macro','16'),10);    // macro changes: 16 bars
  const BLOOM_BAR  = parseInt(P('bloom','160'),10);
  const SEED       = P('seed','track4-ambient-evolving');
  const BAN_PARAM  = P('ban','');

  /* DOM */
  const wrap   = document.getElementById('vizwrap');
  const canvas = document.getElementById('viz');
  const probe  = document.getElementById('probe');
  const starter= document.getElementById('starter');
  const startBtn = document.getElementById('startBtn');
  const audio  = document.getElementById('player');
  const btnPlay= document.getElementById('play');
  const rSeek  = document.getElementById('seek');
  const rVol   = document.getElementById('vol');
  const tTime  = document.getElementById('time');
  const tDur   = document.getElementById('dur');

  audio.src=AUDIO_FILE;

  /* helpers */
  const pad=s=>(s<10?'0':'')+s;
  const fmt=t=>(!isFinite(t)?'0:00':((t/60)|0)+':'+pad((t%60)|0));
  const MS_PER_BAR=(60000/BPM)*4, msForBars=b=>Math.round(MS_PER_BAR*b);
  function webglOK(){
    const c=document.createElement('canvas');
    return !!(c.getContext('webgl2')||c.getContext('webgl')||c.getContext('experimental-webgl'));
  }
  function seededShuffle(arr, seedStr){
    let seed=0;
    for(let i=0;i<seedStr.length;i++) seed=(seed*31 + seedStr.charCodeAt(i))>>>0;
    function rnd(){ seed=(1664525*seed+1013904223)>>>0; return (seed & 0xfffffff)/0x10000000; }
    const a=arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(rnd()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  /* state */
  let ctx, viz, PRESETS={dict:{},names:[]};
  let keys=[], index=0, phase='A', bloomArmed=true, started=false;
  let nanoTO=null, microTO=null, macroTO=null;
  let whiteWatch=null;
  let isPlaying=false;
  const SESSION_BLOCK = new Set();

  /* permanent blocks (your list) */
  const BLOCK_PATTERNS = [
    /flexi/i,
    /spiral\s*artifact/i,
    /geiss.*spiral|spiral.*geiss/i,
    /rovastar/i,
    /loadus/i,
    /Geiss - Desert Rose/i
  ];
  const USER_BLOCK = new Set(BAN_PARAM?BAN_PARAM.split(',').map(s=>s.trim()).filter(Boolean):[]);

  /* packs */
  function mergePresetPacks(){
    const libs=[];
    if (window.butterchurnPresets)           libs.push((butterchurnPresets.default||butterchurnPresets).getPresets());
    if (window.butterchurnPresetsNonMinimal) libs.push((butterchurnPresetsNonMinimal.default||butterchurnPresetsNonMinimal).getPresets());
    if (window.butterchurnPresetsExtra)      libs.push((butterchurnPresetsExtra.default||butterchurnPresetsExtra).getPresets());
    if (window.butterchurnPresetsExtra2)     libs.push((butterchurnPresetsExtra2.default||butterchurnPresetsExtra2).getPresets());
    const dict=Object.assign({},...libs), names=Object.keys(dict);
    return {dict,names};
  }
  function isBlockedName(name){
    if (USER_BLOCK.has(name)) return true;
    for (const re of BLOCK_PATTERNS){ if (re.test(name)) return true; }
    return false;
  }
  function buildPack(){
    const names=PRESETS.names;
    const re=/(cloud|nebula|aura|aurora|mist|plasma|fluid|flow|wave|sea|water|kaleid|spiral|vortex|wormhole|fractal|bloom|pulse|ribbon|lace|glow|minimal|lofi|mono|soft|blur|psy|tunnel|chroma)/i;
    let pool=names.filter(n=>re.test(n) && !isBlockedName(n) && !SESSION_BLOCK.has(n));
    if (pool.length<16) pool=names.filter(n=>!isBlockedName(n) && !SESSION_BLOCK.has(n));
    if (pool.length<8)  pool=names.filter(n=>!SESSION_BLOCK.has(n));
    return seededShuffle(pool, SEED);
  }

  /* sizing */
  function size(){
    const r=wrap.getBoundingClientRect();
    canvas.width=r.width; canvas.height=r.height;
    if(viz) viz.setRendererSize(r.width,r.height);
  }

  /* mutation – texture-sensitive */
  function mutatePreset(base, tMs, intensity=1){
    const p=JSON.parse(JSON.stringify(base));
    p.ob_a=0; p.ib_a=0;
    const s  = Math.sin(tMs*0.00033)*0.5+0.5;
    const s2 = Math.sin(tMs*0.00019+1.2)*0.5+0.5;
    p.decay = Math.min(0.996, 0.986 + 0.012*s*0.7*intensity);
    p.gamma = 1.05 + 0.17*s2*0.7*intensity;
    p.per_frame = (p.per_frame||"") +
      "qB=0.90*qB+0.10*bass_att; qM=0.85*qM+0.15*mid_att; qT=0.80*qT+0.20*treb_att;" +
      "qE = 0.25*qB + 0.45*qM + 0.30*qT;" +
      "rot = rot + 0.0009*sin(time*0.22) + 0.0007*(qE-0.35);" +
      "zoom = zoom*(1.0 + 0.005*sin(time*0.30) + 0.005*(qM-0.3));" +
      "warp = 0.014 + 0.010*sin(time*0.18) + 0.006*(qT-0.3);" +
      "cx = 0.5 + 0.09*sin(time*0.10); cy = 0.5 + 0.09*cos(time*0.08); ";
    if (phase==='B'){ p.per_frame += "rot=rot+0.0009; zoom=zoom*(1.0+0.008*sin(time*0.41)); warp=0.020;"; }
    return p;
  }

  /* load + watchdog */
  function tryLoadName(name, blend){
    try{
      const base=PRESETS.dict[name]; if(!base) throw new Error('missing '+name);
      const tMs=(audio.currentTime||0)*1000;
      viz.loadPreset(mutatePreset(base, tMs, phase==='B'?1.2:1.0), blend);
      armWhiteWatch(name);
      return true;
    }catch(e){ console.warn('preset fail', name, e); return false; }
  }
  function loadByIndex(i, blend=1.0){
    if (!keys.length) keys=buildPack();
    index=((i%keys.length)+keys.length)%keys.length;
    let tries=0, ok=false;
    while(tries<Math.min(6,keys.length) && !(ok=tryLoadName(keys[index], blend))){
      index=(index+1)%keys.length; tries++;
    }
    if (!ok){
      PRESETS=mergePresetPacks(); keys=buildPack(); index=index%keys.length;
      if (!tryLoadName(keys[index], 0.0) && window.butterchurnPresets){
        const core=(butterchurnPresets.default||butterchurnPresets).getPresets();
        PRESETS={dict:core, names:Object.keys(core)};
        keys=PRESETS.names.filter(n=>!isBlockedName(n) && !SESSION_BLOCK.has(n)); index=index%keys.length;
        tryLoadName(keys[index], 0.0);
      }
    }
  }

  /* white-out watchdog */
  function armWhiteWatch(presetName){
    if (whiteWatch) { clearInterval(whiteWatch); whiteWatch=null; }
    const pctx = probe.getContext('2d', {willReadFrequently:true}); if(!pctx) return;
    let brightCount=0;
    whiteWatch=setInterval(()=>{
      try{
        pctx.drawImage(canvas, 0,0, probe.width, probe.height);
        const {data} = pctx.getImageData(0,0, probe.width, probe.height);
        let sum=0, n=0;
        for (let i=0;i<data.length;i+=4){
          const r=data[i]/255, g=data[i+1]/255, b=data[i+2]/255;
          sum += 0.2126*r + 0.7152*g + 0.0722*b; n++;
        }
        const avg = sum/n;
        if (avg > 0.97) brightCount++; else brightCount=0;
        if (brightCount >= 3){
          SESSION_BLOCK.add(presetName);
          loadByIndex(index+1, 1.6);
          brightCount=0;
        }
      }catch(e){ clearInterval(whiteWatch); whiteWatch=null; }
    }, 2000);
  }

  /* grid-snapped (nano=2, micro=4, macro=16) */
  function clearGridTimers(){
    if(nanoTO){clearTimeout(nanoTO);}
    if(microTO){clearTimeout(microTO);}
    if(macroTO){clearTimeout(macroTO);}
    nanoTO=microTO=macroTO=null;
  }
  function barsElapsed(){ return (audio.currentTime*1000)/MS_PER_BAR; }
  function msUntilNextBoundary(spanBars){
    const b = barsElapsed();
    const next = Math.ceil(b / spanBars) * spanBars;
    return Math.max(0, Math.round((next - b) * MS_PER_BAR));
  }
  function scheduleOnGrid(){
    clearGridTimers();
    const nanoSpan=2;
    nanoTO = setTimeout(function tick(){
      loadByIndex(index, 0.6);
      nanoTO=setTimeout(tick, msForBars(nanoSpan));
    }, msUntilNextBoundary(nanoSpan));

    microTO= setTimeout(function tick(){
      loadByIndex(index, 1.0);
      microTO=setTimeout(tick, msForBars(MICRO));
    }, msUntilNextBoundary(MICRO));

    macroTO= setTimeout(function tick(){
      loadByIndex(index+1, 2.2);
      macroTO=setTimeout(tick, msForBars(MACRO));
    }, msUntilNextBoundary(MACRO));
  }

  /* boot (no visuals until play) */
  async function bootCore(){
    if (!webglOK()) { alert('WebGL not available. Enable hardware acceleration.'); return false; }
    const ok = await new Promise(r=>{
      const t=setInterval(()=>{
        if(window.butterchurn) { clearInterval(t); r(true); }
      }, 50);
      setTimeout(()=>{ clearInterval(t); r(true); }, 8000);
    });
    const BC=(window.butterchurn && (butterchurn.createVisualizer?butterchurn:butterchurn.default))||null;
    const merged=mergePresetPacks();
    if (!BC || !merged.names.length){ alert('Preset libraries failed to load.'); return false; }

    PRESETS=merged;
    ctx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
    const src=ctx.createMediaElementSource(audio);
    viz=BC.createVisualizer(ctx, canvas, { width: canvas.clientWidth, height: canvas.clientHeight, pixelRatio: 1 });
    const g=ctx.createGain(); g.gain.value=+rVol.value;
    src.connect(ctx.destination); src.connect(g); viz.connectAudio(g);
    size(); addEventListener('resize', size, {passive:true});
    return true;
  }

  /* start (robust; no alerts on Chrome quirk) */
  window._vizStart = async function(){
    try{
      if (!ctx){
        const ok = await bootCore();
        if (!ok) return;
      }
      if (ctx.state === 'suspended') await ctx.resume();
      if (audio.paused){
        try{ await audio.play(); } catch(e){ /* ignore benign Chrome errors */ }
      }

      if (!started){
        keys  = buildPack();
        index = Math.min(1, Math.max(0, keys.length-1));
        phase = 'A';
        bloomArmed = true;
        started = true;
        isPlaying = true;

        (function loop(){
          if (started && viz && isPlaying){
            viz.render();
          }
          requestAnimationFrame(loop);
        })();

        loadByIndex(index, 0.0);
        scheduleOnGrid();

        let lastT=0;
        audio.addEventListener('timeupdate', ()=>{
          const t=audio.currentTime||0;
          if (audio.duration){
            rSeek.value       = t / audio.duration;
            tTime.textContent = fmt(t);
            tDur.textContent  = fmt(audio.duration);
          }
          if (bloomArmed && t*1000 >= msForBars(BLOOM_BAR)){
            phase='B'; bloomArmed=false; loadByIndex(index, 1.2);
          }
          if (t<1 && lastT>5){
            keys=buildPack(); index=Math.min(1, keys.length-1);
            phase='A'; bloomArmed=true;
            loadByIndex(index, 0.0); scheduleOnGrid();
          }
          lastT=t;
        }, {passive:true});
      } else {
        isPlaying = true;
      }

      starter.style.display='none';
      btnPlay.textContent='⏸';
    }catch(e){
      // keep quiet
    }
  };

  // keep visuals in sync with audio state
  audio.addEventListener('play', () => {
    isPlaying = true;
  });
  audio.addEventListener('pause', () => {
    isPlaying = false;
  });
  audio.addEventListener('ended', () => {
    isPlaying = false;
    btnPlay.textContent = '▶';
  });

  // wide bindings for Safari/Chrome + starter button
  ['pointerdown','touchstart','mousedown'].forEach(ev=>{
    document.addEventListener(ev, ()=>{ if(!started){ window._vizStart(); } }, {once:true, passive:true});
    canvas.addEventListener(ev, ()=>{ if(!started){ window._vizStart(); } }, {passive:true});
  });
  document.addEventListener('keydown', e=>{ if(e.code==='Space'||e.key==='Enter') window._vizStart(); });
  startBtn.addEventListener('click', ()=> window._vizStart());

  // controls
  btnPlay.addEventListener('click', async ()=>{
    try{
      if (!ctx){
        await window._vizStart();
        return;
      }
      if (audio.paused){
        try{ await audio.play(); }catch(e){}
        btnPlay.textContent = '⏸';
      } else {
        audio.pause();
        btnPlay.textContent = '▶';
      }
    }catch(e){}
  });

  rSeek.addEventListener('input', e=>{
    if(audio.duration) audio.currentTime = e.target.value * audio.duration;
  });
  rVol.addEventListener('input', e=>{
    audio.volume = +e.target.value;
  });
  </script>
</body>
</html>
