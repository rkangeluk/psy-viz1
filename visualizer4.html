<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizer – Track 3 (134 BPM, bass-heavy minimal)</title>
<style>
  :root{
    --ui-bg: rgba(255,255,255,.88);
    --ui-fg: #3e3e3e;
    --play-oval: rgba(140, 195, 120, .38); /* soft green tint */
    --font: 400 12px/22px Clarkson, "Proxima Nova", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  html,body{margin:0;height:100%;background:#fff;color:var(--ui-fg);font:var(--font)}
  #vizwrap{position:relative;width:100%;height:100vh;background:#000;overflow:hidden}
  #viz{position:absolute;inset:0;display:block;width:100%;height:100%}

  /* Hover UI */
  .ui{
    position:absolute;left:0;right:0;bottom:0;
    display:flex;align-items:center;gap:.75rem;
    padding:.6rem .8rem;
    background:var(--ui-bg);
    color:var(--ui-fg);
    font:var(--font);
    border-top-left-radius:10px;border-top-right-radius:10px;
    opacity:0;transform:translateY(8px);
    transition:opacity .25s ease, transform .25s ease;
    pointer-events:none;
  }
  #vizwrap:hover .ui, #vizwrap.show-ui .ui{opacity:1;transform:none;pointer-events:auto}

  /* Center play oval */
  .starter{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,rgba(0,0,0,.30),rgba(0,0,0,.45));
  }
  .play-oval{
    all:unset;cursor:pointer;display:flex;align-items:center;justify-content:center;
    width:112px;height:72px;border-radius:9999px;background:var(--play-oval);
    box-shadow:0 6px 22px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.18);
  }
  .play-oval svg{width:24px;height:24px;fill:#fff}

  /* Buttons / sliders */
  .btn{
    all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
    width:36px;height:36px;border-radius:9999px;background:rgba(0,0,0,.06);color:var(--ui-fg)
  }
  .btn:hover{background:rgba(0,0,0,.12)}
  .pill{all:unset;cursor:pointer;background:rgba(0,0,0,.06);padding:.35rem .6rem;border-radius:999px}
  .pill:hover{background:rgba(0,0,0,.12)}
  .label{opacity:.85;min-width:52px;text-align:right}
  .grow{flex:1}
  .spacer{width:8px}
  input[type="range"]{
    -webkit-appearance:none;appearance:none;height:4px;width:240px;background:rgba(0,0,0,.18);
    border-radius:999px;outline:none
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;
    background:#3e3e3e;box-shadow:0 0 0 2px rgba(255,255,255,.8)
  }
</style>
</head>
<body>
  <div id="vizwrap" aria-label="Audio visualizer">
    <canvas id="viz"></canvas>

    <!-- Hover-only UI -->
    <div class="ui" role="group" aria-label="Player controls">
      <button id="play" class="btn" aria-label="Play/Pause">▶</button>
      <span id="time" class="label">0:00</span>
      <input id="seek" type="range" min="0" max="1" step="0.001" value="0" class="grow" aria-label="Seek"/>
      <span id="dur" class="label">0:00</span>
      <div class="spacer"></div>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:110px" aria-label="Volume"/>
      <div class="spacer"></div>
      <button id="next" class="pill" aria-label="Next preset">Next</button>
    </div>

    <!-- Center play oval -->
    <div id="starter" class="starter" role="dialog" aria-label="Click to start">
      <button id="startBtn" class="play-oval" aria-label="Play">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
      </button>
    </div>

    <!-- Hidden audio -->
    <audio id="player" preload="auto" crossorigin="anonymous">
      <source src="track3.mp3" type="audio/mpeg">
      <!-- <source src="track3.wav" type="audio/wav"> -->
    </audio>
  </div>

  <!-- Butterchurn core + extra packs (bigger pool for a fresh “pack”) -->
  <script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurn.min.js"></script>
  <script src="https://unpkg.com/butterchurn@2.6.7/lib/butterchurnExtraImages.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsNonMinimal.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra.min.js"></script>
  <script src="https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresetsExtra2.min.js"></script>

  <script>
  // ===== helpers =====
  function getBC(){
    const bc = window.butterchurn;
    if(!bc) return null;
    return (typeof bc.createVisualizer === 'function') ? bc :
           (bc.default && typeof bc.default.createVisualizer === 'function') ? bc.default : null;
  }
  function mergePresetPacks(){
    const libs = [];
    if (window.butterchurnPresets) libs.push((butterchurnPresets.default||butterchurnPresets).getPresets());
    if (window.butterchurnPresetsNonMinimal) libs.push((butterchurnPresetsNonMinimal.default||butterchurnPresetsNonMinimal).getPresets());
    if (window.butterchurnPresetsExtra) libs.push((butterchurnPresetsExtra.default||butterchurnPresetsExtra).getPresets());
    if (window.butterchurnPresetsExtra2) libs.push((butterchurnPresetsExtra2.default||butterchurnPresetsExtra2).getPresets());
    const dict = Object.assign({}, ...libs);
    return { dict, names: Object.keys(dict) };
  }
  function webglOK(){ const c=document.createElement('canvas'); return !!(c.getContext('webgl2')||c.getContext('webgl')||c.getContext('experimental-webgl')); }
  const pad = s => (s<10?'0':'')+s;
  const fmt = t => { if(!isFinite(t)) return '0:00'; const m=(t/60)|0, s=(t%60)|0; return m+':'+pad(s); };

  // seeded shuffle for consistent per-track order
  function seededShuffle(arr, seedStr){
    let seed = 0; for (let i=0;i<seedStr.length;i++) seed = (seed*31 + seedStr.charCodeAt(i))>>>0;
    function rnd(){ seed = (1664525*seed + 1013904223)>>>0; return (seed & 0xfffffff)/0x10000000; }
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){ const j = Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  // ===== DOM refs =====
  const wrap   = document.getElementById('vizwrap');
  const canvas = document.getElementById('viz');
  const starter= document.getElementById('starter');
  const startBtn= document.getElementById('startBtn');
  const audio  = document.getElementById('player');
  const btnPlay= document.getElementById('play');
  const btnNext= document.getElementById('next');
  const rSeek  = document.getElementById('seek');
  const rVol   = document.getElementById('vol');
  const tTime  = document.getElementById('time');
  const tDur   = document.getElementById('dur');

  // ===== state =====
  let ctx, src, viz, BC, PRESETS;
  let keys = [], index = 0, timer = null;
  let phase = 'A'; // A=32 bars, B=16 bars after bar 80

  // Build a “new pack” filtered to bass/minimal/trippy keywords, then seed-shuffle
  function buildPack(){
    const names = PRESETS.names;
    const reA = /(tunnel|spiral|kaleid|vortex|wormhole|fractal|nebula|minimal|grid|lines|rings|radial)/i;
    const filtered = names.filter(n => reA.test(n));
    const base = filtered.length >= 10 ? filtered : names; // ensure enough
    const shuffled = seededShuffle(base, 'track3-bass-minimal');
    // Start with 2 assertive looks, then the rest
    return shuffled;
  }

  function size(){
    const r = wrap.getBoundingClientRect();
    canvas.width = r.width; canvas.height = r.height;
    if (viz) viz.setRendererSize(r.width, r.height);
  }

  function styleForPhase(preset){
    // make a copy and add subtle bass-forward behavior
    const p = JSON.parse(JSON.stringify(preset));
    p.ob_a = 0; p.ib_a = 0;                     // clean edges
    if (phase === 'A'){                         // percussion/bass forward
      p.decay = Math.min(0.985, p.decay || 0.98);
      p.gamma = p.gamma || 1.2;
      p.wave_r=0.1; p.wave_g=0.95; p.wave_b=0.85; p.wave_a=1; // cool cyan wave
      p.per_frame = (p.per_frame||"") +
        "q1=0.75*q1+0.25*bass_att; zoom=zoom*(1.0+0.012*q1); rot=rot+0.0008*(q1-0.5);";
    } else {                                    // vocals / pad glow
      p.decay = 0.992;
      p.gamma = 1.15;
      p.shapecolorr=0.98; p.shapecolorg=0.15; p.shapecolorb=0.65; p.shapecolora=0.9; // warm magenta accent
      p.per_frame = (p.per_frame||"") +
        "q1=0.85*q1+0.15*bass_att; q2=0.85*q2+0.15*mid_att; qE=0.6*q1+0.4*q2; zoom=zoom*(1.0+0.007*qE); rot=rot+0.0012;";
    }
    return p;
  }

  function loadByIndex(i, blend=1.4){
    index = (i + keys.length) % keys.length;
    const name = keys[index];
    const base = PRESETS.dict[name];
    if (!base) return;
    viz.loadPreset(styleForPhase(base), blend);
    wrap.classList.add('show-ui'); clearTimeout(wrap._h);
    wrap._h = setTimeout(()=>wrap.classList.remove('show-ui'), 1000);
  }

  // Timing: 134 BPM
  const BPM = 134;
  const MS_PER_BAR = (60000 / BPM) * 4;       // ≈1791.0 ms
  const BAR80_TIME = MS_PER_BAR * 80;         // switch point for vocals

  function reschedule(){
    if (timer) clearInterval(timer);
    const bars = (phase === 'A') ? 32 : 16;
    const interval = Math.round(MS_PER_BAR * bars);
    timer = setInterval(()=> loadByIndex(index+1, 1.6), interval);
  }

  function buildVizInput(c, mediaSource){
    // Speakers (clean)
    mediaSource.connect(c.destination);
    // Visuals branch with bass emphasis
    const lowShelf = c.createBiquadFilter(); lowShelf.type='lowshelf'; lowShelf.frequency.value=120; lowShelf.gain.value=+4;
    const hiShelf  = c.createBiquadFilter(); hiShelf.type='highshelf'; hiShelf.frequency.value=4500; hiShelf.gain.value=-2;
    const gain     = c.createGain(); gain.gain.value = +rVol.value; // tie to UI volume
    mediaSource.connect(lowShelf); lowShelf.connect(hiShelf); hiShelf.connect(gain);
    return gain;
  }

  async function boot(){
    if (!webglOK()) { alert('WebGL not available. Enable hardware acceleration.'); return; }
    BC = getBC();
    const merged = mergePresetPacks();
    if (!BC || !merged.names.length) { alert('Preset libraries failed to load.'); return; }
    PRESETS = merged;

    if (!ctx){
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      src = ctx.createMediaElementSource(audio);

      const input = buildVizInput(ctx, src);
      viz = BC.createVisualizer(ctx, canvas, { width: canvas.clientWidth, height: canvas.clientHeight, pixelRatio: 1 });
      viz.connectAudio(input);

      keys = buildPack();
      index = 0;
      loadByIndex(0, 0);

      function loop(){ viz.render(); requestAnimationFrame(loop); }
      requestAnimationFrame(loop);

      size(); window.addEventListener('resize', size);
      reschedule();

      // Switch to Phase B at bar 80
      let switched = false, lastT=0;
      audio.addEventListener('timeupdate', ()=>{
        const t = audio.currentTime||0;
        if (audio.duration){
          rSeek.value = t / audio.duration;
          tTime.textContent = fmt(t);
          tDur.textContent  = fmt(audio.duration);
        }
        if (!switched && t*1000 >= BAR80_TIME){
          phase = 'B'; switched = true;
          // reload current preset with Phase B styling and speed up cadence
          loadByIndex(index, 2.0);
          reschedule();
        }
        // Reset if scrubbing back to start
        if (t<1 && lastT>5){
          phase='A'; switched=false; index=0;
          keys = buildPack(); loadByIndex(0,0); reschedule();
        }
        lastT = t;
      });
    }
    if (ctx.state === 'suspended') await ctx.resume();
  }

  // ===== start + controls =====
  function showErr(e){ console.error('Start/play error:', e); alert('Could not start audio. See console for details.'); }

  async function startPlayback(){
    try{
      if (!ctx) await boot();
      if (ctx.state === 'suspended') await ctx.resume();
      await audio.play();
      starter.style.display='none';
      btnPlay.textContent='⏸';
    }catch(e){ showErr(e); }
  }
  startBtn.addEventListener('click', startPlayback);
  document.getElementById('starter').addEventListener('click', (e)=>{ if (e.target.id==='starter') startPlayback(); });
  canvas.addEventListener('click', startPlayback);
  document.addEventListener('keydown', (e)=>{ if (e.code==='Space'||e.key==='Enter') startPlayback(); });

  btnPlay.addEventListener('click', async ()=>{
    try{
      if (!ctx) await boot();
      if (audio.paused){ await audio.play(); btnPlay.textContent='⏸'; }
      else { audio.pause(); btnPlay.textContent='▶'; }
    }catch(e){ showErr(e); }
  });

  btnNext.addEventListener('click', ()=> loadByIndex(index+1, 1.2));
  document.getElementById('seek').addEventListener('input', e=>{
    if (audio.duration) audio.currentTime = e.target.value * audio.duration;
  });
  document.getElementById('vol').addEventListener('input', e=>{
    audio.volume = +e.target.value;
  });
  </script>
</body>
</html>
